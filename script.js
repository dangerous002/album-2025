const sectionsData = [
  {
    title: "Знакомство",
    text: [
      "Наше знакомство было странным и трепетным одновременно. Мы наблюдали друг за другом, даже не подозревая, что это взаимно. Я тайно фотографировал тебя в колледже, а ты иногда искала меня глазами, проверяла моё расписание. Каждый раз, когда наши взгляды встречались, внутри что-то замирало. Помню, как я впервые подошёл к тебе в курилке забрать 10 рублей, как мы тогда называли друг друга «лп». Я был неуверен, смущён. Помнишь, я сказал: «Чо, вы типа из Бердска, да?» Всё внутри дрожало, и я не знал, как себя вести. Когда Кирилл сказал: «Это те, которые тебе нравятся?» — ты смутилась, слегка посмеявшись. Этот короткий смех стал маленькой искрой, теплом, которое я сразу почувствовал.",
      "С первых сообщений мы будто находили друг друга. Каждое твоё слово отзывалось внутри, делало дни ярче. Мы смеялись над мелочами, играли в Roblox, строили маленькие планы на будущее, ещё не осознавая, что между нами уже что-то особенное. С первых мгновений появилось ощущение близости, которое невозможно описать словами: лёгкое притяжение, трепет в груди и уверенность, что рядом свой человек. С того момент каждый день общения с тобой стал маленьким открытием, полным эмоций и тепла."
    ],
    photos: [
      "1_Знакомство/1.jpg",
      "1_Знакомство/2.jpg",
      "1_Знакомство/3.jpg",
      "1_Знакомство/4.jpg",
      "1_Знакомство/5.jpg",
      "1_Знакомство/6.jpg",
      "1_Знакомство/7.jpg",
      "1_Знакомство/8.jpg",
      "1_Знакомство/9.jpg",
      "1_Знакомство/10.jpg",
      "1_Знакомство/11.jpg",
      "1_Знакомство/12.jpg",
    ],
    videos: [
      "1_Знакомство/13.MP4",
      "1_Знакомство/14.MP4"
    ]
  },
  {
    title: "Первая встреча",
    text: [
      "Первая встреча была 27 июня 2025 года. За день до этого мы уже начали встречаться — ещё только в переписке, но казалось, будто между нами давно что-то есть. В пятницу я приехал к тебе в Бердск. Мы пошли гулять в парк, сели на лавочке и начали тэгать стикер нашими локальными мемами. Я помню своё состояние почти покадрово. Меня трясло от волнения — серьёзно, я путался в мыслях, не мог нормально сформулировать ни одно предложение. Я был в полном шоке от твоей красоты. И при этом рядом с тобой было такое чувство лёгкости, будто время остановилось и всё вокруг перестало существовать. В этот момент мир заиграл новыми, не видаными раньше, красками.",
      "Мы говорили о жизни. Я рассказывал историю о том, как нас с другом выселили из квартиры, делился смешными моментами про друзей. Ты слушала, очень тепло реагировала, когда я рассказывал о себе. А большую часть времени мы смотрели TikTok, записывали кружочки моим друзьям — будто были вместе уже тысячу лет, настолько всё было естественно. Был один момент, который я никогда не забуду. Ты внезапно сказала: «А ты знал, что я мама?». Я тогда просто выпал. Не понял, что ответить. И ты такая спокойная: «Да, у меня есть сын, я его крестила недавно». Напряжение исчезло, мы посмеялись. Это одно из самых теплых воспоминаний. К концу встречи тебе было больно, но ты всё равно проводила меня на вокзал.",
      "Мы стояли, обнимались, оттягивали секунды перед расставанием. Был невероятно красивый закат, электричка подъезжала, и мы сделали фото — одно из тех, что останется на всю жизнь. Когда я убрал телефон, посмотрел тебе в глаза — в тот момент мы были самыми счастливыми людьми на свете. Ты слегка уводила взгляд, смущалась, смотрела, как близко подъезжала электричка. Я думал, может поцеловать тебя, но застеснялся. Тогда ты сама нежно взяла меня и поцеловала. У меня просто вырубились все мысли. Я был в шоке и счастье одновременно. Когда двери открылись, ты сказала: «Ну всё, иди. Я тебя люблю». Я развернулся, чтобы зайти, но внутри что-то рвануло назад. Я обернулся, схватил тебя за талию и поцеловал. Неловко, трясущимся голосом сказал: «Стой… это мой первый раз». И в последний момент прыгнул в вагон.",
      "В электричке я светился. Слезы подходили к глазам сами собой. Ты написала: «Тимоша, я тебя так сильно люблю, это капец». А я ответил, что чувствую то же самое, что никто никогда так не открывался мне. Закат через окно электрички был красным, потом фиолетовым, мир будто замолчал. Я никогда в жизни не ощущал такого счастья. А когда пришёл домой, из окна слышались залпы салюта — как будто весь мир радовался за нас. В тот день я лег спать со слезами и с ощущением, что это начало чего-то невероятного."
    ],
    photos: [
      "2_Первая_встреча/1.jpg",
      "2_Первая_встреча/2.jpg",
      "2_Первая_встреча/3.jpg",
      "2_Первая_встреча/4.jpg",
      "2_Первая_встреча/5.jpg",
      "2_Первая_встреча/6.jpg",
      "2_Первая_встреча/7.jpg",
    ],
    videos: [
      "2_Первая_встреча/8.mp4",
      "2_Первая_встреча/9.mp4",
      "2_Первая_встреча/10.mp4",
    ]
  },
  {
    title: "Мы начали встречаться",
    text: [
      
    ],
    photos: [
      "3_Мы_начали_встречаться/1.jpg",
      "3_Мы_начали_встречаться/2.jpg",
      "3_Мы_начали_встречаться/3.jpg",
      "3_Мы_начали_встречаться/4.jpg",
      "3_Мы_начали_встречаться/5.jpg",
      "3_Мы_начали_встречаться/6.jpg",
      "3_Мы_начали_встречаться/7.jpg",
      "3_Мы_начали_встречаться/8.jpg",
      "3_Мы_начали_встречаться/9.jpg",
    ],
    videos: [
      "3_Мы_начали_встречаться/10.mp4",
      "3_Мы_начали_встречаться/11.mp4",
      "3_Мы_начали_встречаться/12.mp4",
    ]
  },
  {
    title: "Наш июль",
    text: [
      
    ],
    photos: [
      "4_Наш_июль/2.jpg",
      "4_Наш_июль/1.jpg",
      "4_Наш_июль/3.jpg",
      "4_Наш_июль/4.jpg",
      "4_Наш_июль/5.jpg",
      "4_Наш_июль/6.jpg",
      "4_Наш_июль/7.jpg",
      "4_Наш_июль/8.jpg",
      "4_Наш_июль/9.jpg",
      "4_Наш_июль/10.jpg",
      "4_Наш_июль/11.jpg",
      "4_Наш_июль/12.jpg",
      "4_Наш_июль/13.jpg",
      "4_Наш_июль/14.jpg",
    ],
    videos: [
      "4_Наш_июль/15.mp4",
      "4_Наш_июль/16.mp4",
      "4_Наш_июль/17.mp4",
      "4_Наш_июль/18.mp4",
      "4_Наш_июль/19.mp4",
      "4_Наш_июль/20.mp4",
      "4_Наш_июль/21.mp4",
    ]
  },
  {
    title: "Алтай",
    text: [
      
    ],
    photos: [
      "5_Алтай/1.jpg",
      "5_Алтай/2.jpg",
      "5_Алтай/3.jpg",
      "5_Алтай/4.jpg",
      "5_Алтай/5.jpg",
      "5_Алтай/6.jpg",
      "5_Алтай/7.jpg",
      "5_Алтай/8.jpg",
    ],
    videos: []
  },
  {
    title: "Калачинск",
    text: [
      
    ],
    photos: [
      "6_Калачинск/1.jpg",
      "6_Калачинск/2.jpg",
      "6_Калачинск/3.jpg",
      "6_Калачинск/4.jpg",
      "6_Калачинск/5.jpg",
      "6_Калачинск/6.jpg",
      "6_Калачинск/7.jpg",
      "6_Калачинск/8.jpg",
      "6_Калачинск/9.jpg",
      "6_Калачинск/10.jpg",
      "6_Калачинск/11.jpg",
      "6_Калачинск/12.jpg",
    ],
    videos: [
      "6_Калачинск/13.mp4",
    ]
  },
  {
    title: "Последние дни лета",
    text: [
      
    ],
    photos: [
      "7_Последние_дни_лета/1.jpg",
      "7_Последние_дни_лета/2.jpg",
      "7_Последние_дни_лета/3.jpg",
      "7_Последние_дни_лета/4.jpg",
      "7_Последние_дни_лета/5.jpg",
      "7_Последние_дни_лета/6.jpg",
      "7_Последние_дни_лета/7.jpg",
      "7_Последние_дни_лета/8.jpg",
      "7_Последние_дни_лета/9.jpg",
      "7_Последние_дни_лета/10.jpg",
      "7_Последние_дни_лета/11.jpg",
      "7_Последние_дни_лета/12.jpg",
      "7_Последние_дни_лета/13.jpg",
      "7_Последние_дни_лета/14.jpg",
    ],
    videos: [
      "7_Последние_дни_лета/15.mp4",
      "7_Последние_дни_лета/16.mp4",
      "7_Последние_дни_лета/17.MP4",
      "7_Последние_дни_лета/18.MP4",
    ]
  },
  {
    title: "Осень",
    text: [
      
    ],
    photos: [
      "8_Осень/1.jpg",
      "8_Осень/2.jpg",
      "8_Осень/3.jpg",
      "8_Осень/4.jpg",
      "8_Осень/5.jpg",
      "8_Осень/6.jpg",
      "8_Осень/7.jpg",
      "8_Осень/8.jpg",
      "8_Осень/9.jpg",
      "8_Осень/10.jpg",
      "8_Осень/11.jpg",
      "8_Осень/12.jpg",
    ],
    videos: [
      "8_Осень/13.MP4",
      "8_Осень/14.mp4",
      "8_Осень/15.mp4",
      "8_Осень/16.mp4",
      "8_Осень/17.mp4",
      "8_Осень/18.mp4",
      "8_Осень/19.mp4",
      "8_Осень/20.MP4",
      "8_Осень/21.MP4",
      "8_Осень/22.MP4",
      "8_Осень/23.MP4",
      "8_Осень/24.MP4",
      "8_Осень/25.MP4",
    ]
  },
  {
    title: "Наша эстетика",
    text: [
      
    ],
    photos: [
      "9_Наша_эстетика/1.jpg",
      "9_Наша_эстетика/2.jpg",
      "9_Наша_эстетика/3.jpg",
      "9_Наша_эстетика/4.jpg",
      "9_Наша_эстетика/5.jpg",
      "9_Наша_эстетика/6.jpg",
      "9_Наша_эстетика/7.jpg",
      "9_Наша_эстетика/8.jpg",
      "9_Наша_эстетика/9.jpg",
      "9_Наша_эстетика/10.jpg",
      "9_Наша_эстетика/11.jpg",
      "9_Наша_эстетика/12.jpg",
      "9_Наша_эстетика/13.jpg",
      "9_Наша_эстетика/14.jpg",
      "9_Наша_эстетика/15.jpg",
      "9_Наша_эстетика/16.jpg",
      "9_Наша_эстетика/17.jpg",
      "9_Наша_эстетика/18.jpg",
      "9_Наша_эстетика/19.jpg",
    ],
    videos: [
      "9_Наша_эстетика/20.MP4",
      "9_Наша_эстетика/21.MP4",
      "9_Наша_эстетика/22.MP4",
    ]
  },
];

/* Helpers */
const el = (tag, cls = "", html = "") => {
  const e = document.createElement(tag);
  if (cls) e.className = cls;
  if (html) e.innerHTML = html;
  return e;
};

/* Определение видеофайлов */
function isVideoFile(src) {
  if (!src) return false;
  const videoExtensions = ['.mp4', '.MP4', '.mov', '.MOV', '.avi', '.webm', '.mkv'];
  const lowerSrc = src.toLowerCase();
  return videoExtensions.some(ext => lowerSrc.endsWith(ext.toLowerCase()));
}

/* Улучшенный Lightbox для мобильных */
const LB = (() => {
  const root = document.getElementById("lightbox");
  const content = root.querySelector(".lb-content");
  const img = root.querySelector(".lb-image");
  const video = root.querySelector(".lb-video");
  const videoSource = video.querySelector("source");
  const btnClose = root.querySelector(".lb-close");
  const btnPrev = root.querySelector(".lb-prev");
  const btnNext = root.querySelector(".lb-next");
  let items = [],
    idx = 0,
    isAnimating = false,
    isMobile = window.innerWidth <= 768,
    touchStartX = 0,
    touchEndX = 0;

  // Обновляем isMobile при ресайзе
  window.addEventListener('resize', () => {
    isMobile = window.innerWidth <= 768;
  });

  function open(itemsArray, i) {
    items = itemsArray.slice();
    idx = i;
    showItem();
    root.classList.remove("hidden");
    document.body.style.overflow = "hidden";
    document.documentElement.style.overflow = "hidden";
    
    // Добавляем класс для тач-устройств
    if (isMobile) {
      root.classList.add('touch-active');
    }
  }
  
  function close() {
    root.classList.add("hidden");
    img.src = "";
    videoSource.src = "";
    video.classList.add("hidden");
    img.classList.add("hidden");
    video.pause();
    document.body.style.overflow = "";
    document.documentElement.style.overflow = "";
    
    // Удаляем класс для тач-устройств
    root.classList.remove('touch-active');
  }
  
  function prev() {
    if (isAnimating) return;
    idx = (idx - 1 + items.length) % items.length;
    showItemWithAnimation();
    
    // На мобильных временно скрываем стрелки при клике
    if (isMobile) {
      btnPrev.style.opacity = '0.3';
      btnNext.style.opacity = '0.3';
      setTimeout(() => {
        btnPrev.style.opacity = '';
        btnNext.style.opacity = '';
      }, 300);
    }
  }
  
  function next() {
    if (isAnimating) return;
    idx = (idx + 1) % items.length;
    showItemWithAnimation();
    
    // На мобильных временно скрываем стрелки при клике
    if (isMobile) {
      btnPrev.style.opacity = '0.3';
      btnNext.style.opacity = '0.3';
      setTimeout(() => {
        btnPrev.style.opacity = '';
        btnNext.style.opacity = '';
      }, 300);
    }
  }
  
  function showItem() {
    const currentItem = items[idx];
    const isVideo = currentItem.type === "video" || isVideoFile(currentItem.src);
    
    if (isVideo) {
      img.classList.add("hidden");
      
      setTimeout(() => {
        video.classList.remove("hidden");
        videoSource.src = currentItem.src || currentItem;
        video.load();
        
        // На iOS предотвращаем автоматическое полноэкранное воспроизведение
        if (isMobile) {
          video.setAttribute('playsinline', 'true');
          video.setAttribute('webkit-playsinline', 'true');
          video.setAttribute('controls', 'true');
        }
        
        video.play().catch(e => {
          console.log("Автовоспроизведение заблокировано");
        });
      }, 50);
    } else {
      video.classList.add("hidden");
      video.pause();
      
      setTimeout(() => {
        img.classList.remove("hidden");
        img.src = currentItem.src || currentItem;
        img.alt = `Фото ${idx + 1} из ${items.length}`;
      }, 50);
    }
  }
  
  function showItemWithAnimation() {
    if (isAnimating) return;
    isAnimating = true;
    
    content.style.opacity = "0";
    
    setTimeout(() => {
      showItem();
      
      setTimeout(() => {
        content.style.opacity = "1";
        isAnimating = false;
      }, 100);
    }, 200);
  }

  // Обработка свайпов на мобильных
  function handleTouchStart(e) {
    if (!isMobile) return;
    touchStartX = e.changedTouches[0].screenX;
  }
  
  function handleTouchEnd(e) {
    if (!isMobile || isAnimating) return;
    touchEndX = e.changedTouches[0].screenX;
    handleSwipe();
  }
  
  function handleSwipe() {
    const minSwipeDistance = 50;
    const distance = touchStartX - touchEndX;
    
    if (Math.abs(distance) < minSwipeDistance) return;
    
    if (distance > 0) {
      next();
    } else {
      prev();
    }
  }

  btnClose.addEventListener("click", close);
  btnPrev.addEventListener("click", (e) => {
    e.preventDefault();
    e.stopPropagation();
    prev();
  });
  btnNext.addEventListener("click", (e) => {
    e.preventDefault();
    e.stopPropagation();
    next();
  });
  
  // Предотвращаем всплытие событий на мобильных
  if (isMobile) {
    btnPrev.addEventListener('touchstart', (e) => {
      e.preventDefault();
      e.stopPropagation();
      btnPrev.style.opacity = '0.3';
    });
    
    btnPrev.addEventListener('touchend', (e) => {
      e.preventDefault();
      e.stopPropagation();
      prev();
      setTimeout(() => {
        btnPrev.style.opacity = '';
      }, 300);
    });
    
    btnNext.addEventListener('touchstart', (e) => {
      e.preventDefault();
      e.stopPropagation();
      btnNext.style.opacity = '0.3';
    });
    
    btnNext.addEventListener('touchend', (e) => {
      e.preventDefault();
      e.stopPropagation();
      next();
      setTimeout(() => {
        btnNext.style.opacity = '';
      }, 300);
    });
  }
  
  root.addEventListener("click", (e) => {
    if (e.target === root) close();
  });
  
  // Добавляем обработчики свайпов
  root.addEventListener('touchstart', handleTouchStart, { passive: true });
  root.addEventListener('touchend', handleTouchEnd, { passive: true });
  
  document.addEventListener("keydown", (e) => {
    if (root.classList.contains("hidden")) return;
    if (e.key === "Escape") close();
    if (e.key === "ArrowLeft") prev();
    if (e.key === "ArrowRight") next();
  });
  
  // Инициализация прозрачности контента
  content.style.transition = "opacity 0.3s ease";
  content.style.opacity = "1";
  
  // Скрываем стрелки на мобильных через несколько секунд
  let hideTimer;
  function hideArrowsOnMobile() {
    if (!isMobile) return;
    
    clearTimeout(hideTimer);
    btnPrev.style.opacity = '1';
    btnNext.style.opacity = '1';
    btnClose.style.opacity = '1';
    
    hideTimer = setTimeout(() => {
      btnPrev.style.opacity = '0.3';
      btnNext.style.opacity = '0.3';
      btnClose.style.opacity = '0.7';
    }, 2000);
  }
  
  root.addEventListener('mousemove', hideArrowsOnMobile);
  root.addEventListener('touchstart', hideArrowsOnMobile);
  
  return { open, close };
})();

/* Система летающих сердечек */
function createHeartsSystem() {
  let heartCount = 0;
  const maxHearts = 20;
  
  // SVG для сердечка
  const heartSVG = `<svg viewBox="0 0 32 29" xmlns="http://www.w3.org/2000/svg">
    <path d="M23.6,0c-3.4,0-6.3,2.7-7.6,5.6C14.7,2.7,11.8,0,8.4,0C3.8,0,0,3.8,0,8.4c0,9.4,9.5,11.9,16,21.2
      c6.1-9.3,16-12.1,16-21.2C32,3.8,28.2,0,23.6,0z" fill="currentColor"/>
  </svg>`;
  
  function createHeart() {
    if (heartCount >= maxHearts) return;
    if (window.innerWidth <= 768) return;
    
    heartCount++;
    
    const heart = document.createElement('div');
    heart.className = 'heart';
    
    // Чуть меньшие размеры сердечек
    const size = 20 + Math.random() * 20; // 20-40px
    heart.style.width = `${size}px`;
    heart.style.height = `${size}px`;
    
    // Случайные цвета сердечек
    const colors = [
      '#ff6bcb', '#ff8ac7', '#ffa8c3', '#ffc6bf', 
      '#ffe4f0', '#ffd1e0', '#ffb8d0', '#ff9fc0',
      '#ff6bd0', '#ff8ad0'
    ];
    const color = colors[Math.floor(Math.random() * colors.length)];
    heart.style.color = color;
    
    // Случайная начальная позиция внизу экрана
    const startX = Math.random() * window.innerWidth;
    
    // Разные анимации с долетом до середины экрана (50vh)
    const animations = ['floatHeart', 'floatHeart2', 'floatHeart3'];
    const animation = animations[Math.floor(Math.random() * animations.length)];
    const duration = 6 + Math.random() * 6; // 6-12 секунд
    
    // Устанавливаем стили
    heart.style.position = 'fixed';
    heart.style.left = `${startX}px`;
    heart.style.top = `${window.innerHeight}px`; // Начинаем снизу экрана (viewport)
    heart.style.zIndex = '1';
    heart.style.pointerEvents = 'none';
    heart.style.animation = `${animation} ${duration}s linear forwards`;
    heart.style.opacity = '0';
    
    // Добавляем SVG сердечко
    heart.innerHTML = heartSVG;
    
    // Добавляем сердечко в DOM
    document.body.appendChild(heart);
    
    // Удаляем сердечко после анимации
    setTimeout(() => {
      if (heart.parentNode) {
        heart.remove();
        heartCount--;
      }
    }, duration * 1000);
  }
  
  // Создаем начальные сердечки
  for (let i = 0; i < 10; i++) {
    setTimeout(() => createHeart(), i * 300);
  }
  
  // Периодически добавляем новые сердечки
  const heartInterval = setInterval(() => {
    if (document.hidden) return;
    createHeart();
  }, 600);
  
  // Сохраняем интервал для очистки
  window.heartInterval = heartInterval;
}

/* Slider с правильной адаптивностью */
class Slider {
  constructor(photos, videos, mount) {
    this.allItems = [
      ...photos.map(src => ({ src, type: "image" })),
      ...(videos || []).map(src => ({ src, type: "video" }))
    ];
    
    this.mount = mount;
    this.current = 0;
    this.isAnimating = false;
    this.loadedCount = 0;
    this.totalToLoad = this.allItems.length;
    this.maxDisplayHeight = 0;
    this.isMobile = window.innerWidth <= 768;

    // Обновляем isMobile при ресайзе
    window.addEventListener('resize', () => {
      this.isMobile = window.innerWidth <= 768;
      this.updateSliderForMobile();
    });

    this.wrapper = el("div", "slider-wrapper");
    this.viewport = el("div", "slider-viewport");
    this.track = el("div", "track");
    this.wrapper.appendChild(this.viewport);
    this.viewport.appendChild(this.track);

    // Стрелки только для десктопа
    if (!this.isMobile) {
      this.prevBtn = el("button", "slider-button prev", "◀");
      this.nextBtn = el("button", "slider-button next", "▶");
      this.prevBtn.setAttribute("aria-label", "Предыдущее фото");
      this.nextBtn.setAttribute("aria-label", "Следующее фото");
      this.wrapper.appendChild(this.prevBtn);
      this.wrapper.appendChild(this.nextBtn);
    }

    this.mount.appendChild(this.wrapper);

    this.slides = [];
    
    this.buildSlides();
    this.startLoadingAndCalculateHeight();
    this.updateSliderForMobile();
  }

  updateSliderForMobile() {
    if (this.isMobile) {
      // Убираем рамку и фон на мобильных
      this.wrapper.style.border = 'none';
      this.wrapper.style.background = 'transparent';
      this.wrapper.style.boxShadow = 'none';
      this.wrapper.style.padding = '0';
      this.wrapper.style.borderRadius = '0';
      
      // Убираем стрелки если они есть
      if (this.prevBtn && this.nextBtn) {
        this.prevBtn.style.display = 'none';
        this.nextBtn.style.display = 'none';
      }
      
      // Добавляем свайпы для мобильных
      this.addSwipeSupport();
    } else {
      // Восстанавливаем стили для десктопа
      this.wrapper.style.border = '2px solid rgba(255, 228, 240, 0.35)';
      this.wrapper.style.background = '#181818';
      this.wrapper.style.boxShadow = '0 8px 20px rgba(0, 0, 0, 0.4)';
      this.wrapper.style.padding = '16px';
      this.wrapper.style.borderRadius = '18px';
      
      // Показываем стрелки если они есть
      if (this.prevBtn && this.nextBtn) {
        this.prevBtn.style.display = 'flex';
        this.nextBtn.style.display = 'flex';
      }
    }
  }

  addSwipeSupport() {
    let touchStartX = 0;
    let touchEndX = 0;
    
    const handleTouchStart = (e) => {
      touchStartX = e.changedTouches[0].screenX;
    };
    
    const handleTouchEnd = (e) => {
      if (this.isAnimating) return;
      touchEndX = e.changedTouches[0].screenX;
      handleSwipe();
    };
    
    const handleSwipe = () => {
      const minSwipeDistance = 50;
      const distance = touchStartX - touchEndX;
      
      if (Math.abs(distance) < minSwipeDistance) return;
      
      if (distance > 0) {
        this.goTo((this.current + 1) % this.allItems.length);
      } else {
        this.goTo((this.current - 1 + this.allItems.length) % this.allItems.length);
      }
    };
    
    this.track.addEventListener('touchstart', handleTouchStart, { passive: true });
    this.track.addEventListener('touchend', handleTouchEnd, { passive: true });
  }

  buildSlides() {
    this.track.innerHTML = "";
    this.allItems.forEach((item, i) => {
      const s = el("div", "slide");
      
      if (item.type === "video") {
        const video = el("video");
        video.src = item.src;
        video.controls = true;
        video.setAttribute("playsinline", "true");
        video.setAttribute("webkit-playsinline", "true");
        video.setAttribute("preload", "metadata");
        video.setAttribute("aria-label", `Видео ${i + 1} из ${this.allItems.length}`);
        video.onerror = () => {
          console.warn(`Не удалось загрузить видео: ${item.src}`);
          this.onItemLoaded();
        };
        s.appendChild(video);
      } else {
        const img = el("img");
        img.src = item.src;
        img.loading = "lazy";
        img.setAttribute("alt", `Фото ${i + 1} из ${this.allItems.length}`);
        img.onerror = () => {
          console.warn(`Не удалось загрузить фото: ${item.src}`);
          this.onItemLoaded();
        };
        s.appendChild(img);
      }
      
      const num = el("div", "slide-number", `${i + 1}/${this.allItems.length}`);
      s.appendChild(num);
      this.slides.push(s);
      this.track.appendChild(s);
    });
  }

  startLoadingAndCalculateHeight() {
    const promises = this.allItems.map((item, index) => {
      return new Promise((resolve) => {
        if (item.type === "video") {
          const video = document.createElement("video");
          video.preload = "metadata";
          video.onloadedmetadata = () => {
            if (!this.isMobile) {
              this.calculateDisplayHeight(video, true, index);
            }
            resolve();
          };
          video.onerror = () => {
            console.warn(`Не удалось загрузить видео: ${item.src}`);
            this.onItemLoaded();
            resolve();
          };
          video.src = item.src;
        } else {
          const img = new Image();
          img.onload = () => {
            if (!this.isMobile) {
              this.calculateDisplayHeight(img, false, index);
            }
            resolve();
          };
          img.onerror = () => {
            console.warn(`Не удалось загрузить фото: ${item.src}`);
            this.onItemLoaded();
            resolve();
          };
          img.src = item.src;
        }
      });
    });

    Promise.all(promises).then(() => {
      if (!this.isMobile) {
        this.setFinalHeight();
      } else {
        // На мобильных устанавливаем минимальную высоту
        this.wrapper.style.height = 'auto';
        this.wrapper.style.minHeight = '250px';
      }
      
      this.update();
      this.bind();
      
      this.loadedCount = this.allItems.length;
      this.updateLoadingProgress();
    });
  }

  calculateDisplayHeight(element, isVideo, index) {
    const originalWidth = isVideo ? element.videoWidth : element.naturalWidth;
    const originalHeight = isVideo ? element.videoHeight : element.naturalHeight;
    
    if (originalWidth === 0 || originalHeight === 0) return;
    
    const ratio = originalHeight / originalWidth;
    const sliderMaxWidth = this.wrapper.clientWidth * 0.92;
    let displayHeight = sliderMaxWidth * ratio;
    
    const maxAllowedHeight = window.innerHeight * 0.6;
    
    displayHeight = Math.min(displayHeight, maxAllowedHeight);
    this.maxDisplayHeight = Math.max(this.maxDisplayHeight, displayHeight);
    
    this.loadedCount++;
    this.updateLoadingProgress();
  }

  setFinalHeight() {
    const padding = 32;
    const slideNumberHeight = 40;
    const finalHeight = this.maxDisplayHeight + padding + slideNumberHeight;
    const minHeight = 300;
    
    this.wrapper.style.height = Math.max(finalHeight, minHeight) + "px";
    this.wrapper.classList.add('visible');
  }

  updateLoadingProgress() {
    const progress = Math.round((this.loadedCount / this.totalToLoad) * 100);
    const loadingText = document.querySelector('.loading-text');
    if (loadingText && progress <= 100) {
      loadingText.textContent = `Загрузка воспоминаний... ${progress}%`;
    }
  }

  bind() {
    if (!this.isMobile && this.prevBtn && this.nextBtn) {
      this.prevBtn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (this.isAnimating) return;
        this.goTo((this.current - 1 + this.allItems.length) % this.allItems.length);
      });
      
      this.nextBtn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (this.isAnimating) return;
        this.goTo((this.current + 1) % this.allItems.length);
      });
    }
    
    this.track.addEventListener("click", (e) => {
      // На мобильных предотвращаем открытие лайтбокса при свайпе
      if (this.isMobile) {
        const target = e.target;
        if (target.tagName === 'VIDEO' || target.closest('video')) {
          // Для видео открываем лайтбокс
          e.preventDefault();
          const idx = Array.from(this.slides).indexOf(e.target.closest(".slide"));
          if (idx !== -1) {
            LB.open(this.allItems, idx);
          }
        } else if (target.tagName === 'IMG' || target.closest('img')) {
          // Для изображений открываем лайтбокс
          e.preventDefault();
          const idx = Array.from(this.slides).indexOf(e.target.closest(".slide"));
          if (idx !== -1) {
            LB.open(this.allItems, idx);
          }
        }
      } else {
        // На десктопе обычное поведение
        const s = e.target.closest(".slide");
        if (!s) return;
        const idx = this.slides.indexOf(s);
        LB.open(this.allItems, idx);
      }
    });
  }

  goTo(index) {
    if (this.isAnimating || index === this.current) return;
    
    this.isAnimating = true;
    const oldIndex = this.current;
    this.current = index;
    
    this.slides[oldIndex].classList.remove("active");
    this.slides[oldIndex].classList.add("exit");
    
    setTimeout(() => {
      this.slides[oldIndex].style.display = "none";
      this.slides[oldIndex].classList.remove("exit");
      
      this.slides[this.current].style.display = "flex";
      
      setTimeout(() => {
        this.slides[this.current].classList.add("active");
        this.isAnimating = false;
      }, 50);
    }, 300);
  }

  update() {
    this.slides.forEach((s, i) => {
      s.style.display = i === this.current ? "flex" : "none";
      if (i === this.current) {
        setTimeout(() => {
          s.classList.add("active");
        }, 50);
      } else {
        s.classList.remove("active");
      }
    });
    
    // Показываем обертку
    this.wrapper.classList.add('visible');
  }
}

/* Анимация обложки при прокрутке */
function setupHeroScrollAnimation() {
  const hero = document.getElementById('hero');
  const heroBg = document.getElementById('heroBg');
  
  function handleScroll() {
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    const heroHeight = hero.offsetHeight;
    const scrollPercent = Math.min(scrollTop / heroHeight, 1);
    
    const parallaxOffset = scrollTop * 0.5;
    heroBg.style.transform = `scale(1.05) translateY(${parallaxOffset * 0.2}px)`;
    
    const brightness = 0.86 - (scrollPercent * 0.56);
    const blur = scrollPercent * 4;
    const saturate = 1.1 - (scrollPercent * 0.5);
    
    heroBg.style.filter = `brightness(${brightness}) saturate(${saturate}) blur(${blur}px)`;
    
    if (scrollPercent > 0.8) {
      hero.classList.remove('hero-scrolled');
      hero.classList.add('hero-hidden');
    } else if (scrollPercent > 0.2) {
      hero.classList.add('hero-scrolled');
      hero.classList.remove('hero-hidden');
    } else {
      hero.classList.remove('hero-scrolled');
      hero.classList.remove('hero-hidden');
    }
  }
  
  window.addEventListener('scroll', handleScroll, { passive: true });
  window.addEventListener('resize', handleScroll, { passive: true });
  handleScroll();
  
  if (window.innerWidth > 768) {
    document.addEventListener('mousemove', (e) => {
      if (hero.classList.contains('hero-hidden')) return;
      
      const mouseX = e.clientX / window.innerWidth;
      const mouseY = e.clientY / window.innerHeight;
      
      const moveX = (mouseX - 0.5) * 20;
      const moveY = (mouseY - 0.5) * 20;
      
      heroBg.style.transform = `scale(1.05) translate(${moveX}px, ${moveY}px)`;
    });
  }
}

/* Система появления элементов при скролле */
function setupScrollReveal() {
  let ticking = false;
  
  function checkVisibility() {
    if (ticking) return;
    
    ticking = true;
    
    requestAnimationFrame(() => {
      const elements = document.querySelectorAll('.memory-section, .section-divider, .fade-in, .slider-wrapper');
      const windowHeight = window.innerHeight;
      
      const triggerPoint = windowHeight * 0.15;
      
      elements.forEach((element, index) => {
        const rect = element.getBoundingClientRect();
        
        const isVisible = rect.top < windowHeight - triggerPoint;
        
        if (isVisible && !element.classList.contains('visible')) {
          setTimeout(() => {
            element.classList.add('visible');
          }, Math.min(index * 30, 200));
        }
      });
      
      ticking = false;
    });
  }
  
  setTimeout(checkVisibility, 100);
  
  window.addEventListener('scroll', () => {
    checkVisibility();
  }, { passive: true });
  
  window.addEventListener('resize', checkVisibility, { passive: true });
  
  setInterval(checkVisibility, 300);
}

/* Музыкальный плеер */
function setupMusicPlayer() {
  const audio = document.getElementById('backgroundMusic');
  const playPauseBtn = document.getElementById('playPauseBtn');
  const miniPlayPauseBtn = document.getElementById('miniPlayPauseBtn');
  const muteBtn = document.getElementById('muteBtn');
  const volumeSlider = document.getElementById('volumeSlider');
  const closePlayerBtn = document.getElementById('closePlayerBtn');
  const expandPlayerBtn = document.getElementById('expandPlayerBtn');
  const playerControls = document.querySelector('.player-controls');
  const playerMinimized = document.getElementById('playerMinimized');
  const musicPlayer = document.getElementById('musicPlayer');
  
  let isPlaying = false;
  let isMuted = false;
  let lastVolume = 0.3;
  
  audio.volume = lastVolume;
  
  function checkAudioSupport() {
    const canPlayMP3 = audio.canPlayType('audio/mp3');
    const canPlayOGG = audio.canPlayType('audio/ogg');
    
    if (!canPlayMP3 && !canPlayOGG) {
      console.warn('Браузер не поддерживает аудио форматы');
      musicPlayer.style.display = 'none';
      return false;
    }
    return true;
  }
  
  function updatePlayButton() {
    const icon = isPlaying ? 'fa-pause' : 'fa-play';
    playPauseBtn.innerHTML = `<i class="fas ${icon}"></i>`;
    miniPlayPauseBtn.innerHTML = `<i class="fas ${icon}"></i>`;
  }
  
  function updateMuteButton() {
    let icon;
    if (isMuted) {
      icon = 'fa-volume-mute';
    } else if (audio.volume >= 0.5) {
      icon = 'fa-volume-up';
    } else if (audio.volume > 0) {
      icon = 'fa-volume-down';
    } else {
      icon = 'fa-volume-off';
    }
    muteBtn.innerHTML = `<i class="fas ${icon}"></i>`;
  }
  
  function togglePlayPause() {
    if (isPlaying) {
      audio.pause();
    } else {
      audio.play().catch(e => {
        console.log('Автовоспроизведение заблокировано. Нажмите на кнопку воспроизведения.');
        playPauseBtn.style.animation = 'none';
        setTimeout(() => {
          playPauseBtn.style.animation = 'pulse 1s ease-in-out';
        }, 10);
      });
    }
    isPlaying = !isPlaying;
    updatePlayButton();
  }
  
  function toggleMute() {
    if (isMuted) {
      audio.volume = lastVolume;
      volumeSlider.value = lastVolume;
      isMuted = false;
    } else {
      lastVolume = audio.volume;
      audio.volume = 0;
      volumeSlider.value = 0;
      isMuted = true;
    }
    updateMuteButton();
  }
  
  function changeVolume() {
    const volume = parseFloat(volumeSlider.value);
    audio.volume = volume;
    
    if (volume === 0) {
      isMuted = true;
    } else {
      isMuted = false;
      lastVolume = volume;
    }
    
    updateMuteButton();
  }
  
  function minimizePlayer() {
    playerControls.style.display = 'none';
    playerMinimized.style.display = 'flex';
    musicPlayer.style.width = 'auto';
  }
  
  function expandPlayer() {
    playerMinimized.style.display = 'none';
    playerControls.style.display = 'flex';
    musicPlayer.style.width = 'auto';
  }
  
  function closePlayer() {
    minimizePlayer();
  }
  
  if (checkAudioSupport()) {
    // Добавляем обработчики с preventDefault для мобильных
    const addSafeClickListener = (element, handler) => {
      element.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        handler();
      });
      
      element.addEventListener('touchstart', (e) => {
        if (e.cancelable) {
          e.preventDefault();
        }
      }, { passive: false });
      
      element.addEventListener('touchend', (e) => {
        e.preventDefault();
        e.stopPropagation();
        handler();
      });
    };
    
    addSafeClickListener(playPauseBtn, togglePlayPause);
    addSafeClickListener(miniPlayPauseBtn, togglePlayPause);
    addSafeClickListener(muteBtn, toggleMute);
    addSafeClickListener(closePlayerBtn, closePlayer);
    addSafeClickListener(expandPlayerBtn, expandPlayer);
    
    volumeSlider.addEventListener('input', changeVolume);
    volumeSlider.addEventListener('touchstart', (e) => {
      e.stopPropagation();
    }, { passive: true });
    
    audio.addEventListener('play', () => {
      isPlaying = true;
      updatePlayButton();
    });
    
    audio.addEventListener('pause', () => {
      isPlaying = false;
      updatePlayButton();
    });
    
    audio.addEventListener('volumechange', updateMuteButton);
    
    // Автовоспроизведение с задержкой
    setTimeout(() => {
      audio.play().catch(e => {
        console.log('Автовоспроизведение музыки отложено. Пользователь может включить музыку вручную.');
      });
    }, 2000);
    
    // Инициализация иконок
    updatePlayButton();
    updateMuteButton();
    
    // Автоматическое сворачивание через 10 секунд
    setTimeout(minimizePlayer, 10000);
  }
}

/* Render sections */
function renderSections() {
  const root = document.getElementById("sections");
  sectionsData.forEach((sec, idx) => {
    const section = el("section", "memory-section");
    const title = el("h3", "sparkle-title", sec.title);
    section.appendChild(title);
    
    const mount = el("div", "slider-mount");
    section.appendChild(mount);
    
    const textContainer = el("div", "section-text");
    sec.text.forEach(paragraph => {
      if (paragraph.trim()) {
        const p = el("p", "", paragraph);
        textContainer.appendChild(p);
      }
    });
    if (textContainer.children.length > 0) {
      section.appendChild(textContainer);
    }
    
    root.appendChild(section);
    new Slider(sec.photos, sec.videos || [], mount);

    // Добавляем разделительную полоску ТОЛЬКО между секциями, не после последней
    if (idx !== sectionsData.length - 1) {
      const divider = el("div", "section-divider");
      root.appendChild(divider);
    }
  });
}

/* Отслеживание загрузки всех слайдеров */
let totalSlidersLoaded = 0;
const totalSliders = sectionsData.length;

function onSliderLoaded() {
  totalSlidersLoaded++;
  
  const totalProgress = Math.round((totalSlidersLoaded / totalSliders) * 100);
  const loadingText = document.querySelector('.loading-text');
  if (loadingText && totalProgress <= 100) {
    loadingText.textContent = `Подготовка слайдеров... ${totalProgress}%`;
  }
  
  if (totalSlidersLoaded === totalSliders) {
    setTimeout(() => {
      const loader = document.getElementById('loadingOverlay');
      if (loader) {
        loader.style.opacity = '0';
        setTimeout(() => {
          loader.style.display = 'none';
          setupScrollReveal();
          createHeartsSystem();
          setupMusicPlayer();
          
          setTimeout(() => {
            document.querySelectorAll('.memory-section, .fade-in').forEach(el => {
              const rect = el.getBoundingClientRect();
              if (rect.top < window.innerHeight * 0.9) {
                el.classList.add('visible');
              }
            });
          }, 100);
        }, 500);
      }
    }, 500);
  }
}

// Модифицируем Slider для отслеживания загрузки
const OriginalSlider = Slider;
Slider = function(...args) {
  const instance = new OriginalSlider(...args);
  
  const originalSetFinalHeight = instance.setFinalHeight;
  instance.setFinalHeight = function() {
    if (originalSetFinalHeight) {
      originalSetFinalHeight.call(this);
    }
    onSliderLoaded();
  };
  
  // Также отслеживаем загрузку на мобильных
  instance.update = function() {
    this.constructor.prototype.update.call(this);
    onSliderLoaded();
  };
  
  return instance;
};

/* Инициализация */
window.addEventListener("load", () => {
  window.scrollTo(0, 0);
  
  // Предотвращаем масштабирование на мобильных
  document.addEventListener('touchmove', function(e) {
    if(e.scale !== 1) {
      e.preventDefault();
    }
  }, { passive: false });
  
  // Предотвращаем двойной тап для зумирования
  let lastTouchEnd = 0;
  document.addEventListener('touchend', function(e) {
    const now = Date.now();
    if (now - lastTouchEnd <= 300) {
      e.preventDefault();
    }
    lastTouchEnd = now;
  }, { passive: false });
  
  setupHeroScrollAnimation();
  renderSections();
  
  setTimeout(() => {
    setupScrollReveal();
  }, 100);
});

// Очистка интервала сердечек
window.addEventListener('beforeunload', () => {
  if (window.heartInterval) {
    clearInterval(window.heartInterval);
  }
});

// Фоллбек на случай если прелоадер не скрылся
setTimeout(() => {
  const loader = document.getElementById('loadingOverlay');
  if (loader && loader.style.display !== 'none') {
    loader.style.opacity = '0';
    setTimeout(() => {
      loader.style.display = 'none';
      setupScrollReveal();
      createHeartsSystem();
      setupMusicPlayer();
    }, 500);
  }
}, 8000);