const sectionsData = [
  {
    title: "Знакомство",
    text: [
      "Наше знакомство было странным и трепетным одновременно. Мы наблюдали друг за другом, даже не подозревая, что это взаимно. Я тайно фотографировал тебя в колледже, а ты иногда искала меня глазами, проверяла моё расписание. Каждый раз, когда наши взгляды встречались, внутри что-то замирало. Помню, как я впервые подошёл к тебе в курилке забрать 10 рублей, как мы тогда называли друг друга «лп». Я был неуверен, смущён. Помнишь, я сказал: «Чо, вы типа из Бердска, да?» Всё внутри дрожало, и я не знал, как себя вести. Когда Кирилл сказал: «Это те, которые тебе нравятся?» — ты смутилась, слегка посмеявшись. Этот короткий смех стал маленькой искрой, теплом, которое я сразу почувствовал.",
      "С первых сообщений мы будто находили друг друга. Каждое твоё слово отзывалось внутри, делало дни ярче. Мы смеялись над мелочами, играли в Roblox, строили маленькие планы на будущее, ещё не осознавая, что между нами уже что-то особенное. С первых мгновений появилось ощущение близости, которое невозможно описать словами: лёгкое притяжение, трепет в груди и уверенность, что рядом свой человек. С того момент каждый день общения с тобой стал маленьким открытием, полным эмоций и тепла."
    ],
    photos: [
      "1. Знакомство/1.jpg",
      "1. Знакомство/2.jpg",
      "1. Знакомство/3.jpg",
      "1. Знакомство/4.jpg",
      "1. Знакомство/5.jpg",
      "1. Знакомство/6.jpg",
      "1. Знакомство/7.jpg",
      "1. Знакомство/8.jpg",
      "1. Знакомство/9.jpg",
      "1. Знакомство/10.jpg",
      "1. Знакомство/11.jpg",
      "1. Знакомство/12.jpg",
    ],
    videos: [
      "1. Знакомство/13.MP4",
      "1. Знакомство/14.MP4"
    ]
  },
  {
    title: "Первая встреча",
    text: [
      "Первая встреча была 27 июня 2025 года. За день до этого мы уже начали встречаться — ещё только в переписке, но казалось, будто между нами давно что-то есть. В пятницу я приехал к тебе в Бердск. Мы пошли гулять в парк, сели на лавочке и начали тэгать стикер нашими локальными мемами. Я помню своё состояние почти покадрово. Меня трясло от волнения — серьёзно, я путался в мыслях, не мог нормально сформулировать ни одно предложение. Я был в полном шоке от твоей красоты. И при этом рядом с тобой было такое чувство лёгкости, будто время остановилось и всё вокруг перестало существовать. В этот момент мир заиграл новыми, не видаными раньше, красками.",
      "Мы говорили о жизни. Я рассказывал историю о том, как нас с другом выселили из квартиры, делился смешными моментами про друзей. Ты слушала, очень тепло реагировала, когда я рассказывал о себе. А большую часть времени мы смотрели TikTok, записывали кружочки моим друзьям — будто были вместе уже тысячу лет, настолько всё было естественно. Был один момент, который я никогда не забуду. Ты внезапно сказала: «А ты знал, что я мама?». Я тогда просто выпал. Не понял, что ответить. И ты такая спокойная: «Да, у меня есть сын, я его крестила недавно». Напряжение исчезло, мы посмеялись. Это одно из самых теплых воспоминаний. К концу встречи тебе было больно, но ты всё равно проводила меня на вокзал.",
      "Мы стояли, обнимались, оттягивали секунды перед расставанием. Был невероятно красивый закат, электричка подъезжала, и мы сделали фото — одно из тех, что останется на всю жизнь. Когда я убрал телефон, посмотрел тебе в глаза — в тот момент мы были самыми счастливыми людьми на свете. Ты слегка уводила взгляд, смущалась, смотрела, как близко подъезжала электричка. Я думал, может поцеловать тебя, но застеснялся. Тогда ты сама нежно взяла меня и поцеловала. У меня просто вырубились все мысли. Я был в шоке и счастье одновременно. Когда двери открылись, ты сказала: «Ну всё, иди. Я тебя люблю». Я развернулся, чтобы зайти, но внутри что-то рвануло назад. Я обернулся, схватил тебя за талию и поцеловал. Неловко, трясущимся голосом сказал: «Стой… это мой первый раз». И в последний момент прыгнул в вагон.",
      "В электричке я светился. Слезы подходили к глазам сами собой. Ты написала: «Тимоша, я тебя так сильно люблю, это капец». А я ответил, что чувствую то же самое, что никто никогда так не открывался мне. Закат через окно электрички был красным, потом фиолетовым, мир будто замолчал. Я никогда в жизни не ощущал такого счастья. А когда пришёл домой, из окна слышались залпы салюта — как будто весь мир радовался за нас. В тот день я лег спать со слезами и с ощущением, что это начало чего-то невероятного."
    ],
    photos: [
      "2. Первая встреча/1.jpg",
      "2. Первая встреча/2.jpg",
      "2. Первая встреча/3.jpg",
      "2. Первая встреча/4.jpg",
      "2. Первая встреча/5.jpg",
      "2. Первая встреча/6.jpg",
      "2. Первая встреча/7.jpg",
    ],
    videos: [
      "2. Первая встреча/8.mp4",
      "2. Первая встреча/9.mp4",
      "2. Первая встреча/10.mp4",
    ]
  },
  {
    title: "Мы начали встречаться",
    text: [
      
    ],
    photos: [
      "3. Мы начали встречаться/1.jpg",
      "3. Мы начали встречаться/2.jpg",
      "3. Мы начали встречаться/3.jpg",
      "3. Мы начали встречаться/4.jpg",
      "3. Мы начали встречаться/5.jpg",
      "3. Мы начали встречаться/6.jpg",
      "3. Мы начали встречаться/7.jpg",
      "3. Мы начали встречаться/8.jpg",
      "3. Мы начали встречаться/9.jpg",
    ],
    videos: [
      "3. Мы начали встречаться/10.mp4",
      "3. Мы начали встречаться/11.mp4",
      "3. Мы начали встречаться/12.mp4",
    ]
  },
  {
    title: "Наш июль",
    text: [
      
    ],
    photos: [
      "4. Наш июль/1.jpg",
      "4. Наш июль/2.jpg",
      "4. Наш июль/3.jpg",
      "4. Наш июль/4.jpg",
      "4. Наш июль/5.jpg",
      "4. Наш июль/6.jpg",
      "4. Наш июль/7.jpg",
      "4. Наш июль/8.jpg",
      "4. Наш июль/9.jpg",
      "4. Наш июль/10.jpg",
      "4. Наш июль/11.jpg",
      "4. Наш июль/12.jpg",
      "4. Наш июль/13.jpg",
      "4. Наш июль/14.jpg",
    ],
    videos: [
      "4. Наш июль/15.mp4",
      "4. Наш июль/16.mp4",
      "4. Наш июль/17.mp4",
      "4. Наш июль/18.mp4",
      "4. Наш июль/19.mp4",
      "4. Наш июль/20.mp4",
      "4. Наш июль/21.mp4",
    ]
  },
  {
    title: "Алтай",
    text: [
      
    ],
    photos: [
      "5. Алтай/1.jpg",
      "5. Алтай/2.jpg",
      "5. Алтай/3.jpg",
      "5. Алтай/4.jpg",
      "5. Алтай/5.jpg",
      "5. Алтай/6.jpg",
      "5. Алтай/7.jpg",
      "5. Алтай/8.jpg",
    ],
    videos: []
  },
  {
    title: "Калачинск",
    text: [
      
    ],
    photos: [
      "6. Калачинск/1.jpg",
      "6. Калачинск/2.jpg",
      "6. Калачинск/3.jpg",
      "6. Калачинск/4.jpg",
      "6. Калачинск/5.jpg",
      "6. Калачинск/6.jpg",
      "6. Калачинск/7.jpg",
      "6. Калачинск/8.jpg",
      "6. Калачинск/9.jpg",
      "6. Калачинск/10.jpg",
      "6. Калачинск/11.jpg",
      "6. Калачинск/12.jpg",
    ],
    videos: [
      "6. Калачинск/13.mp4",
    ]
  },
  {
    title: "Последние дни лета",
    text: [
      
    ],
    photos: [
      "7. Последние дни лета/1.jpg",
      "7. Последние дни лета/2.jpg",
      "7. Последние дни лета/3.jpg",
      "7. Последние дни лета/4.jpg",
      "7. Последние дни лета/5.jpg",
      "7. Последние дни лета/6.jpg",
      "7. Последние дни лета/7.jpg",
      "7. Последние дни лета/8.jpg",
      "7. Последние дни лета/9.jpg",
      "7. Последние дни лета/10.jpg",
      "7. Последние дни лета/11.jpg",
      "7. Последние дни лета/12.jpg",
      "7. Последние дни лета/13.jpg",
      "7. Последние дни лета/14.jpg",
    ],
    videos: [
      "7. Последние дни лета/15.mp4",
      "7. Последние дни лета/16.mp4",
      "7. Последние дни лета/17.MP4",
      "7. Последние дни лета/18.MP4",
    ]
  },
  {
    title: "Осень",
    text: [
      
    ],
    photos: [
      "8. Осень/1.jpg",
      "8. Осень/2.jpg",
      "8. Осень/3.jpg",
      "8. Осень/4.jpg",
      "8. Осень/5.jpg",
      "8. Осень/6.jpg",
      "8. Осень/7.jpg",
      "8. Осень/8.jpg",
      "8. Осень/9.jpg",
      "8. Осень/10.jpg",
      "8. Осень/11.jpg",
      "8. Осень/12.jpg",
    ],
    videos: [
      "8. Осень/13.MP4",
      "8. Осень/14.mp4",
      "8. Осень/15.mp4",
      "8. Осень/16.mp4",
      "8. Осень/17.mp4",
      "8. Осень/18.mp4",
      "8. Осень/19.mp4",
      "8. Осень/20.MP4",
      "8. Осень/21.MP4",
      "8. Осень/22.MP4",
      "8. Осень/23.MP4",
      "8. Осень/24.MP4",
      "8. Осень/25.MP4",
    ]
  },
  {
    title: "Наша эстетика",
    text: [
      
    ],
    photos: [
      "9. Наша эстетика/1.jpg",
      "9. Наша эстетика/2.jpg",
      "9. Наша эстетика/3.jpg",
      "9. Наша эстетика/4.jpg",
      "9. Наша эстетика/5.jpg",
      "9. Наша эстетика/6.jpg",
      "9. Наша эстетика/7.jpg",
      "9. Наша эстетика/8.jpg",
      "9. Наша эстетика/9.jpg",
      "9. Наша эстетика/10.jpg",
      "9. Наша эстетика/11.jpg",
      "9. Наша эстетика/12.jpg",
      "9. Наша эстетика/13.jpg",
      "9. Наша эстетика/14.jpg",
      "9. Наша эстетика/15.jpg",
      "9. Наша эстетика/16.jpg",
      "9. Наша эстетика/17.jpg",
      "9. Наша эстетика/18.jpg",
      "9. Наша эстетика/19.jpg",
    ],
    videos: [
      "9. Наша эстетика/20.MP4",
      "9. Наша эстетика/21.MP4",
      "9. Наша эстетика/22.MP4",
    ]
  },
];

/* Helpers */
const el = (tag, cls = "", html = "") => {
  const e = document.createElement(tag);
  if (cls) e.className = cls;
  if (html) e.innerHTML = html;
  return e;
};

/* Определение видеофайлов */
function isVideoFile(src) {
  if (!src) return false;
  const videoExtensions = ['.mp4', '.MP4', '.mov', '.MOV', '.avi', '.webm', '.mkv'];
  const lowerSrc = src.toLowerCase();
  return videoExtensions.some(ext => lowerSrc.endsWith(ext.toLowerCase()));
}

/* Lightbox с исправлениями */
const LB = (() => {
  const root = document.getElementById("lightbox");
  const content = root.querySelector(".lb-content");
  const img = root.querySelector(".lb-image");
  const video = root.querySelector(".lb-video");
  const videoSource = video.querySelector("source");
  const btnClose = root.querySelector(".lb-close");
  const btnPrev = root.querySelector(".lb-prev");
  const btnNext = root.querySelector(".lb-next");
  let items = [],
    idx = 0,
    isAnimating = false;

  function open(itemsArray, i) {
    items = itemsArray.slice();
    idx = i;
    showItem();
    root.classList.remove("hidden");
    document.body.style.overflow = "hidden"; // Блокируем скролл
  }
  
  function close() {
    root.classList.add("hidden");
    img.src = "";
    videoSource.src = "";
    video.classList.add("hidden");
    img.classList.add("hidden");
    video.pause();
    document.body.style.overflow = ""; // Восстанавливаем скролл
  }
  
  function prev() {
    if (isAnimating) return;
    idx = (idx - 1 + items.length) % items.length;
    showItemWithAnimation();
  }
  
  function next() {
    if (isAnimating) return;
    idx = (idx + 1) % items.length;
    showItemWithAnimation();
  }
  
  function showItem() {
    const currentItem = items[idx];
    const isVideo = currentItem.type === "video" || isVideoFile(currentItem.src);
    
    if (isVideo) {
      // Сначала скрываем изображение
      img.classList.add("hidden");
      
      // Затем показываем видео
      setTimeout(() => {
        video.classList.remove("hidden");
        videoSource.src = currentItem.src || currentItem;
        video.load();
        video.play().catch(e => console.log("Автовоспроизведение заблокировано"));
      }, 50);
    } else {
      // Сначала скрываем видео
      video.classList.add("hidden");
      video.pause();
      
      // Затем показываем изображение
      setTimeout(() => {
        img.classList.remove("hidden");
        img.src = currentItem.src || currentItem;
        img.alt = `Фото ${idx + 1} из ${items.length}`;
      }, 50);
    }
  }
  
  function showItemWithAnimation() {
    if (isAnimating) return;
    isAnimating = true;
    
    // Анимация исчезновения
    content.style.opacity = "0";
    
    setTimeout(() => {
      showItem();
      
      // Анимация появления
      setTimeout(() => {
        content.style.opacity = "1";
        isAnimating = false;
      }, 100);
    }, 200);
  }

  btnClose.addEventListener("click", close);
  btnPrev.addEventListener("click", prev);
  btnNext.addEventListener("click", next);
  root.addEventListener("click", (e) => {
    if (e.target === root) close();
  });
  document.addEventListener("keydown", (e) => {
    if (root.classList.contains("hidden")) return;
    if (e.key === "Escape") close();
    if (e.key === "ArrowLeft") prev();
    if (e.key === "ArrowRight") next();
  });
  
  // Инициализация прозрачности контента
  content.style.transition = "opacity 0.3s ease";
  content.style.opacity = "1";
  
  return { open, close };
})();

/* Система летающих сердечек */
function createHeartsSystem() {
  let heartCount = 0;
  const maxHearts = 20;
  
  // SVG для сердечка
  const heartSVG = `<svg viewBox="0 0 32 29" xmlns="http://www.w3.org/2000/svg">
    <path d="M23.6,0c-3.4,0-6.3,2.7-7.6,5.6C14.7,2.7,11.8,0,8.4,0C3.8,0,0,3.8,0,8.4c0,9.4,9.5,11.9,16,21.2
      c6.1-9.3,16-12.1,16-21.2C32,3.8,28.2,0,23.6,0z" fill="currentColor"/>
  </svg>`;
  
  function createHeart() {
    if (heartCount >= maxHearts) return;
    if (window.innerWidth <= 768) return;
    
    heartCount++;
    
    const heart = document.createElement('div');
    heart.className = 'heart';
    
    // Чуть меньшие размеры сердечек
    const size = 20 + Math.random() * 20; // 20-40px
    heart.style.width = `${size}px`;
    heart.style.height = `${size}px`;
    
    // Случайные цвета сердечек
    const colors = [
      '#ff6bcb', '#ff8ac7', '#ffa8c3', '#ffc6bf', 
      '#ffe4f0', '#ffd1e0', '#ffb8d0', '#ff9fc0',
      '#ff6bd0', '#ff8ad0'
    ];
    const color = colors[Math.floor(Math.random() * colors.length)];
    heart.style.color = color;
    
    // Случайная начальная позиция внизу экрана
    const startX = Math.random() * window.innerWidth;
    
    // Разные анимации с долетом до середины экрана (50vh)
    const animations = ['floatHeart', 'floatHeart2', 'floatHeart3'];
    const animation = animations[Math.floor(Math.random() * animations.length)];
    const duration = 6 + Math.random() * 6; // 6-12 секунд
    
    // Устанавливаем стили
    heart.style.position = 'fixed';
    heart.style.left = `${startX}px`;
    heart.style.top = `${window.innerHeight}px`; // Начинаем снизу экрана (viewport)
    heart.style.zIndex = '1';
    heart.style.pointerEvents = 'none';
    heart.style.animation = `${animation} ${duration}s linear forwards`;
    heart.style.opacity = '0';
    
    // Добавляем SVG сердечко
    heart.innerHTML = heartSVG;
    
    // Добавляем сердечко в DOM
    document.body.appendChild(heart);
    
    // Удаляем сердечко после анимации
    setTimeout(() => {
      if (heart.parentNode) {
        heart.remove();
        heartCount--;
      }
    }, duration * 1000);
  }
  
  // Создаем начальные сердечки
  for (let i = 0; i < 10; i++) {
    setTimeout(() => createHeart(), i * 300);
  }
  
  // Периодически добавляем новые сердечки
  const heartInterval = setInterval(() => {
    if (document.hidden) return;
    createHeart();
  }, 600);
  
  // Сохраняем интервал для очистки
  window.heartInterval = heartInterval;
}

/* Slider с правильным расчетом высоты по отображаемым размерам */
class Slider {
  constructor(photos, videos, mount) {
    this.allItems = [
      ...photos.map(src => ({ src, type: "image" })),
      ...(videos || []).map(src => ({ src, type: "video" }))
    ];
    
    this.mount = mount;
    this.current = 0;
    this.isAnimating = false;
    this.loadedCount = 0;
    this.totalToLoad = this.allItems.length;
    this.maxDisplayHeight = 0;

    this.wrapper = el("div", "slider-wrapper");
    this.viewport = el("div", "slider-viewport");
    this.track = el("div", "track");
    this.wrapper.appendChild(this.viewport);
    this.viewport.appendChild(this.track);

    this.prevBtn = el("button", "slider-button prev", "◀");
    this.nextBtn = el("button", "slider-button next", "▶");
    this.prevBtn.setAttribute("aria-label", "Предыдущее фото");
    this.nextBtn.setAttribute("aria-label", "Следующее фото");
    this.wrapper.appendChild(this.prevBtn);
    this.wrapper.appendChild(this.nextBtn);

    this.mount.appendChild(this.wrapper);

    this.slides = [];
    
    this.buildSlides();
    this.startLoadingAndCalculateHeight();
  }

  buildSlides() {
    this.track.innerHTML = "";
    this.allItems.forEach((item, i) => {
      const s = el("div", "slide");
      
      if (item.type === "video") {
        const video = el("video");
        video.src = item.src;
        video.controls = true;
        video.setAttribute("aria-label", `Видео ${i + 1} из ${this.allItems.length}`);
        video.onerror = () => {
          console.warn(`Не удалось загрузить видео: ${item.src}`);
          this.onItemLoaded();
        };
        s.appendChild(video);
      } else {
        const img = el("img");
        img.src = item.src;
        img.setAttribute("alt", `Фото ${i + 1} из ${this.allItems.length}`);
        img.onerror = () => {
          console.warn(`Не удалось загрузить фото: ${item.src}`);
          this.onItemLoaded();
        };
        s.appendChild(img);
      }
      
      const num = el("div", "slide-number", `${i + 1}/${this.allItems.length}`);
      s.appendChild(num);
      this.slides.push(s);
      this.track.appendChild(s);
    });
  }

  startLoadingAndCalculateHeight() {
    const promises = this.allItems.map((item, index) => {
      return new Promise((resolve) => {
        if (item.type === "video") {
          const video = document.createElement("video");
          video.preload = "metadata";
          video.onloadedmetadata = () => {
            this.calculateDisplayHeight(video, true, index);
            resolve();
          };
          video.onerror = () => {
            console.warn(`Не удалось загрузить видео: ${item.src}`);
            this.onItemLoaded();
            resolve();
          };
          video.src = item.src;
        } else {
          const img = new Image();
          img.onload = () => {
            this.calculateDisplayHeight(img, false, index);
            resolve();
          };
          img.onerror = () => {
            console.warn(`Не удалось загрузить фото: ${item.src}`);
            this.onItemLoaded();
            resolve();
          };
          img.src = item.src;
        }
      });
    });

    Promise.all(promises).then(() => {
      this.setFinalHeight();
      this.update();
      this.bind();
      
      this.loadedCount = this.allItems.length;
      this.updateLoadingProgress();
    });
  }

  calculateDisplayHeight(element, isVideo, index) {
    const originalWidth = isVideo ? element.videoWidth : element.naturalWidth;
    const originalHeight = isVideo ? element.videoHeight : element.naturalHeight;
    
    if (originalWidth === 0 || originalHeight === 0) return;
    
    const ratio = originalHeight / originalWidth;
    const sliderMaxWidth = this.wrapper.clientWidth * 0.92;
    let displayHeight = sliderMaxWidth * ratio;
    
    const isMobile = window.innerWidth <= 768;
    const maxAllowedHeight = isMobile ? 
      (window.innerWidth <= 480 ? window.innerHeight * 0.45 : window.innerHeight * 0.5) : 
      window.innerHeight * 0.6;
    
    displayHeight = Math.min(displayHeight, maxAllowedHeight);
    this.maxDisplayHeight = Math.max(this.maxDisplayHeight, displayHeight);
    
    this.loadedCount++;
    this.updateLoadingProgress();
  }

  setFinalHeight() {
    const padding = 32;
    const slideNumberHeight = 40;
    const finalHeight = this.maxDisplayHeight + padding + slideNumberHeight;
    const minHeight = window.innerWidth <= 768 ? 250 : 300;
    
    this.wrapper.style.height = Math.max(finalHeight, minHeight) + "px";
    this.wrapper.classList.add('visible');
  }

  updateLoadingProgress() {
    const progress = Math.round((this.loadedCount / this.totalToLoad) * 100);
    const loadingText = document.querySelector('.loading-text');
    if (loadingText && progress <= 100) {
      loadingText.textContent = `Загрузка воспоминаний... ${progress}%`;
    }
  }

  bind() {
    this.prevBtn.addEventListener("click", () => {
      if (this.isAnimating) return;
      this.goTo((this.current - 1 + this.allItems.length) % this.allItems.length);
    });
    
    this.nextBtn.addEventListener("click", () => {
      if (this.isAnimating) return;
      this.goTo((this.current + 1) % this.allItems.length);
    });
    
    this.track.addEventListener("click", (e) => {
      const s = e.target.closest(".slide");
      if (!s) return;
      const idx = this.slides.indexOf(s);
      LB.open(this.allItems, idx);
    });
  }

  goTo(index) {
    if (this.isAnimating || index === this.current) return;
    
    this.isAnimating = true;
    const oldIndex = this.current;
    this.current = index;
    
    this.slides[oldIndex].classList.remove("active");
    this.slides[oldIndex].classList.add("exit");
    
    setTimeout(() => {
      this.slides[oldIndex].style.display = "none";
      this.slides[oldIndex].classList.remove("exit");
      
      this.slides[this.current].style.display = "flex";
      
      setTimeout(() => {
        this.slides[this.current].classList.add("active");
        this.isAnimating = false;
      }, 50);
    }, 300);
  }

  update() {
    this.slides.forEach((s, i) => {
      s.style.display = i === this.current ? "flex" : "none";
      if (i === this.current) {
        setTimeout(() => {
          s.classList.add("active");
        }, 50);
      } else {
        s.classList.remove("active");
      }
    });
  }
}

/* Анимация обложки при прокрутке */
function setupHeroScrollAnimation() {
  const hero = document.getElementById('hero');
  const heroBg = document.getElementById('heroBg');
  
  function handleScroll() {
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    const heroHeight = hero.offsetHeight;
    const scrollPercent = Math.min(scrollTop / heroHeight, 1);
    
    const parallaxOffset = scrollTop * 0.5;
    heroBg.style.transform = `scale(1.05) translateY(${parallaxOffset * 0.2}px)`;
    
    const brightness = 0.86 - (scrollPercent * 0.56);
    const blur = scrollPercent * 4;
    const saturate = 1.1 - (scrollPercent * 0.5);
    
    heroBg.style.filter = `brightness(${brightness}) saturate(${saturate}) blur(${blur}px)`;
    
    if (scrollPercent > 0.8) {
      hero.classList.remove('hero-scrolled');
      hero.classList.add('hero-hidden');
    } else if (scrollPercent > 0.2) {
      hero.classList.add('hero-scrolled');
      hero.classList.remove('hero-hidden');
    } else {
      hero.classList.remove('hero-scrolled');
      hero.classList.remove('hero-hidden');
    }
  }
  
  window.addEventListener('scroll', handleScroll);
  window.addEventListener('resize', handleScroll);
  handleScroll();
  
  if (window.innerWidth > 768) {
    document.addEventListener('mousemove', (e) => {
      if (hero.classList.contains('hero-hidden')) return;
      
      const mouseX = e.clientX / window.innerWidth;
      const mouseY = e.clientY / window.innerHeight;
      
      const moveX = (mouseX - 0.5) * 20;
      const moveY = (mouseY - 0.5) * 20;
      
      heroBg.style.transform = `scale(1.05) translate(${moveX}px, ${moveY}px)`;
    });
  }
}

/* Система появления элементов при скролле */
function setupScrollReveal() {
  let ticking = false;
  
  function checkVisibility() {
    if (ticking) return;
    
    ticking = true;
    
    requestAnimationFrame(() => {
      const elements = document.querySelectorAll('.memory-section, .section-divider, .fade-in, .slider-wrapper');
      const windowHeight = window.innerHeight;
      
      const triggerPoint = windowHeight * 0.15;
      
      elements.forEach((element, index) => {
        const rect = element.getBoundingClientRect();
        
        const isVisible = rect.top < windowHeight - triggerPoint;
        
        if (isVisible && !element.classList.contains('visible')) {
          setTimeout(() => {
            element.classList.add('visible');
          }, Math.min(index * 30, 200));
        }
      });
      
      ticking = false;
    });
  }
  
  setTimeout(checkVisibility, 100);
  
  window.addEventListener('scroll', () => {
    checkVisibility();
  }, { passive: true });
  
  window.addEventListener('resize', checkVisibility);
  
  setInterval(checkVisibility, 300);
}

/* Музыкальный плеер */
function setupMusicPlayer() {
  const audio = document.getElementById('backgroundMusic');
  const playPauseBtn = document.getElementById('playPauseBtn');
  const miniPlayPauseBtn = document.getElementById('miniPlayPauseBtn');
  const muteBtn = document.getElementById('muteBtn');
  const volumeSlider = document.getElementById('volumeSlider');
  const closePlayerBtn = document.getElementById('closePlayerBtn');
  const expandPlayerBtn = document.getElementById('expandPlayerBtn');
  const playerControls = document.querySelector('.player-controls');
  const playerMinimized = document.getElementById('playerMinimized');
  const musicPlayer = document.getElementById('musicPlayer');
  
  let isPlaying = false;
  let isMuted = false;
  let lastVolume = 0.3;
  
  // Установить громкость по умолчанию
  audio.volume = lastVolume;
  
  // Проверить поддержку аудио
  function checkAudioSupport() {
    const canPlayMP3 = audio.canPlayType('audio/mp3');
    const canPlayOGG = audio.canPlayType('audio/ogg');
    
    if (!canPlayMP3 && !canPlayOGG) {
      console.warn('Браузер не поддерживает аудио форматы');
      musicPlayer.style.display = 'none';
      return false;
    }
    return true;
  }
  
  // Обновить иконку кнопки воспроизведения
  function updatePlayButton() {
    const icon = isPlaying ? 'fa-pause' : 'fa-play';
    playPauseBtn.innerHTML = `<i class="fas ${icon}"></i>`;
    miniPlayPauseBtn.innerHTML = `<i class="fas ${icon}"></i>`;
  }
  
  // Обновить иконку кнопки звука
  function updateMuteButton() {
    let icon;
    if (isMuted) {
      icon = 'fa-volume-mute';
    } else if (audio.volume >= 0.5) {
      icon = 'fa-volume-up';
    } else if (audio.volume > 0) {
      icon = 'fa-volume-down';
    } else {
      icon = 'fa-volume-off';
    }
    muteBtn.innerHTML = `<i class="fas ${icon}"></i>`;
  }
  
  // Воспроизвести/пауза
  function togglePlayPause() {
    if (isPlaying) {
      audio.pause();
    } else {
      audio.play().catch(e => {
        console.log('Автовоспроизведение заблокировано. Нажмите на кнопку воспроизведения.');
        // Показываем уведомление для пользователя
        playPauseBtn.style.animation = 'none';
        setTimeout(() => {
          playPauseBtn.style.animation = 'pulse 1s ease-in-out';
        }, 10);
      });
    }
    isPlaying = !isPlaying;
    updatePlayButton();
  }
  
  // Включить/выключить звук
  function toggleMute() {
    if (isMuted) {
      // Включаем звук
      audio.volume = lastVolume;
      volumeSlider.value = lastVolume;
      isMuted = false;
    } else {
      // Выключаем звук
      lastVolume = audio.volume;
      audio.volume = 0;
      volumeSlider.value = 0;
      isMuted = true;
    }
    updateMuteButton();
  }
  
  // Изменить громкость
  function changeVolume() {
    const volume = parseFloat(volumeSlider.value);
    audio.volume = volume;
    
    if (volume === 0) {
      isMuted = true;
    } else {
      isMuted = false;
      lastVolume = volume;
    }
    
    updateMuteButton();
  }
  
  // Свернуть плеер
  function minimizePlayer() {
    playerControls.style.display = 'none';
    playerMinimized.style.display = 'flex';
    musicPlayer.style.width = 'auto';
  }
  
  // Развернуть плеер
  function expandPlayer() {
    playerMinimized.style.display = 'none';
    playerControls.style.display = 'flex';
    musicPlayer.style.width = 'auto';
  }
  
  // Закрыть плеер
  function closePlayer() {
    minimizePlayer();
  }
  
  // Инициализация
  if (checkAudioSupport()) {
    // События кнопок
    playPauseBtn.addEventListener('click', togglePlayPause);
    miniPlayPauseBtn.addEventListener('click', togglePlayPause);
    muteBtn.addEventListener('click', toggleMute);
    volumeSlider.addEventListener('input', changeVolume);
    closePlayerBtn.addEventListener('click', closePlayer);
    expandPlayerBtn.addEventListener('click', expandPlayer);
    
    // События аудио
    audio.addEventListener('play', () => {
      isPlaying = true;
      updatePlayButton();
    });
    
    audio.addEventListener('pause', () => {
      isPlaying = false;
      updatePlayButton();
    });
    
    audio.addEventListener('volumechange', updateMuteButton);
    
    // Автовоспроизведение с задержкой
    setTimeout(() => {
      audio.play().catch(e => {
        console.log('Автовоспроизведение музыки отложено. Пользователь может включить музыку вручную.');
      });
    }, 2000);
    
    // Инициализация иконок
    updatePlayButton();
    updateMuteButton();
    
    // Автоматическое сворачивание через 10 секунд
    setTimeout(minimizePlayer, 10000);
  }
}

/* Render sections */
function renderSections() {
  const root = document.getElementById("sections");
  sectionsData.forEach((sec, idx) => {
    const section = el("section", "memory-section");
    const title = el("h3", "sparkle-title", sec.title);
    section.appendChild(title);
    
    const mount = el("div", "slider-mount");
    section.appendChild(mount);
    
    const textContainer = el("div", "section-text");
    sec.text.forEach(paragraph => {
      if (paragraph.trim()) {
        const p = el("p", "", paragraph);
        textContainer.appendChild(p);
      }
    });
    if (textContainer.children.length > 0) {
      section.appendChild(textContainer);
    }
    
    root.appendChild(section);
    new Slider(sec.photos, sec.videos || [], mount);

    // Добавляем разделительную полоску ТОЛЬКО между секциями, не после последней
    if (idx !== sectionsData.length - 1) {
      const divider = el("div", "section-divider");
      root.appendChild(divider);
    }
  });
}

/* Отслеживание загрузки всех слайдеров */
let totalSlidersLoaded = 0;
const totalSliders = sectionsData.length;

function onSliderLoaded() {
  totalSlidersLoaded++;
  
  const totalProgress = Math.round((totalSlidersLoaded / totalSliders) * 100);
  const loadingText = document.querySelector('.loading-text');
  if (loadingText && totalProgress <= 100) {
    loadingText.textContent = `Подготовка слайдеров... ${totalProgress}%`;
  }
  
  if (totalSlidersLoaded === totalSliders) {
    setTimeout(() => {
      const loader = document.getElementById('loadingOverlay');
      if (loader) {
        loader.style.opacity = '0';
        setTimeout(() => {
          loader.style.display = 'none';
          setupScrollReveal();
          createHeartsSystem();
          setupMusicPlayer();
          
          setTimeout(() => {
            document.querySelectorAll('.memory-section, .fade-in').forEach(el => {
              const rect = el.getBoundingClientRect();
              if (rect.top < window.innerHeight * 0.9) {
                el.classList.add('visible');
              }
            });
          }, 100);
        }, 500);
      }
    }, 500);
  }
}

// Модифицируем Slider для отслеживания загрузки
const OriginalSlider = Slider;
Slider = function(...args) {
  const instance = new OriginalSlider(...args);
  
  const originalSetFinalHeight = instance.setFinalHeight;
  instance.setFinalHeight = function() {
    originalSetFinalHeight.call(this);
    onSliderLoaded();
  };
  
  return instance;
};

/* Инициализация */
window.addEventListener("load", () => {
  window.scrollTo(0, 0);
  
  setupHeroScrollAnimation();
  renderSections();
  
  setTimeout(() => {
    setupScrollReveal();
  }, 100);
});

// Очистка интервала сердечек
window.addEventListener('beforeunload', () => {
  if (window.heartInterval) {
    clearInterval(window.heartInterval);
  }
});

// Фоллбек на случай если прелоадер не скрылся
setTimeout(() => {
  const loader = document.getElementById('loadingOverlay');
  if (loader && loader.style.display !== 'none') {
    loader.style.opacity = '0';
    setTimeout(() => {
      loader.style.display = 'none';
      setupScrollReveal();
      createHeartsSystem();
      setupMusicPlayer();
    }, 500);
  }
}, 8000);