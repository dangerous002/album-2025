const sectionsData = [
  {
    title: "Знакомство",
    text: [
      "Наше знакомство было странным и трепетным одновременно. Мы наблюдали друг за другом, даже не подозревая, что это взаимно. Я тайно фотографировал тебя в колледже, а ты иногда искала меня глазами, проверяла моё расписание. Каждый раз, когда наши взгляды встречались, внутри что-то замирало. Помню, как я впервые подошёл к тебе в курилке забрать 10 рублей, как мы тогда называли друг друга «лп». Я был неуверен, смущён. Помнишь, я сказал: «Чо, вы типа из Бердска, да?» Всё внутри дрожало, и я не знал, как себя вести. Когда Кирилл сказал: «Это те, которые тебе нравятся?» — ты смутилась, слегка посмеявшись. Этот короткий смех стал маленькой искрой, теплом, которое я сразу почувствовал.",
      "С первых сообщений мы будто находили друг друга. Каждое твоё слово отзывалось внутри, делало дни ярче. Мы смеялись над мелочами, играли в Roblox, строили маленькие планы на будущее, ещё не осознавая, что между нами уже что-то особенное. С первых мгновений появилось ощущение близости, которое невозможно описать словами: лёгкое притяжение, трепет в груди и уверенность, что рядом свой человек. С того момент каждый день общения с тобой стал маленьким открытием, полным эмоций и тепла."
    ],
    photos: [
      ["https://storage.yandexcloud.net/album-2025/1/1.JPG", "1/1.jpg"],
      ["https://storage.yandexcloud.net/album-2025/1/2.jpg", "1/2.jpg"],
      ["https://storage.yandexcloud.net/album-2025/1/3.jpg", "1/3.jpg"],
      ["https://storage.yandexcloud.net/album-2025/1/4.jpg", "1/4.jpg"],
      ["https://storage.yandexcloud.net/album-2025/1/5.jpg", "1/5.jpg"],
      ["https://storage.yandexcloud.net/album-2025/1/6.jpg", "1/6.jpg"],
      ["https://storage.yandexcloud.net/album-2025/1/7.jpg", "1/7.jpg"],
      ["https://storage.yandexcloud.net/album-2025/1/8.jpg", "1/8.jpg"],
      ["https://storage.yandexcloud.net/album-2025/1/9.jpg", "1/9.jpg"],
      ["https://storage.yandexcloud.net/album-2025/1/10.jpg", "1/10.jpg"],
      ["https://storage.yandexcloud.net/album-2025/1/11.jpg", "1/11.jpg"],
      ["https://storage.yandexcloud.net/album-2025/1/12.jpg", "1/12.jpg"],
    ],
    videos: [
      ["https://storage.yandexcloud.net/album-2025/1/13.MP4", "1/13.MP4"],
      ["https://storage.yandexcloud.net/album-2025/1/14.MP4", "1/14.MP4"]
    ]
  },
  {
    title: "Первая встреча",
    text: [
      "Первая встреча была 27 июня 2025 года. За день до этого мы уже начали встречаться — ещё только в переписке, но казалось, будто между нами давно что-то есть. В пятницу я приехал к тебе в Бердск. Мы пошли гулять в парк, сели на лавочке и начали тэгать стикер нашими локальными мемами. Я помню своё состояние почти покадрово. Меня трясло от волнения — серьёзно, я путался в мыслях, не мог нормально сформулировать ни одно предложение. Я был в полном шоке от твоей красоты. И при этом рядом с тобой было такое чувство лёгкости, будто время остановилось и всё вокруг перестало существовать. В этот момент мир заиграл новыми, не видаными раньше, красками.",
      "Мы говорили о жизни. Я рассказывал историю о том, как нас с другом выселили из квартиры, делился смешными моментами про друзей. Ты слушала, очень тепло реагировала, когда я рассказывал о себе. А большую часть времени мы смотрели TikTok, записывали кружочки моим друзьям — будто были вместе уже тысячу лет, настолько всё было естественно. Был один момент, который я никогда не забуду. Ты внезапно сказала: «А ты знал, что я мама?». Я тогда просто выпал. Не понял, что ответить. И ты такая спокойная: «Да, у меня есть сын, я его крестила недавно». Напряжение исчезло, мы посмеялись. Это одно из самых теплых воспоминаний. К концу встречи тебе было больно, но ты всё равно проводила меня на вокзал.",
      "Мы стояли, обнимались, оттягивали секунды перед расставанием. Был невероятно красивый закат, электричка подъезжала, и мы сделали фото — одно из тех, что останется на всю жизнь. Когда я убрал телефон, посмотрел тебе в глаза — в тот момент мы были самыми счастливыми людьми на свете. Ты слегка уводила взгляд, смущалась, смотрела, как близко подъезжала электричка. Я думал, может поцеловать тебя, но застеснялся. Тогда ты сама нежно взяла меня и поцеловала. У меня просто вырубились все мысли. Я был в шоке и счастье одновременно. Когда двери открылись, ты сказала: «Ну всё, иди. Я тебя люблю». Я развернулся, чтобы зайти, но внутри что-то рвануло назад. Я обернулся, схватил тебя за талию и поцеловал. Неловко, трясущимся голосом сказал: «Стой… это мой первый раз». И в последний момент прыгнул в вагон.",
      "В электричке я светился. Слезы подходили к глазам сами собой. Ты написала: «Тимоша, я тебя так сильно люблю, это капец». А я ответил, что чувствую то же самое, что никто никогда так не открывался мне. Закат через окно электрички был красным, потом фиолетовым, мир будто замолчал. Я никогда в жизни не ощущал такого счастья. А когда пришёл домой, из окна слышались залпы салюта — как будто весь мир радовался за нас. В тот день я лег спать со слезами и с ощущением, что это начало чего-то невероятного."
    ],
    photos: [
      ["https://storage.yandexcloud.net/album-2025/2/1.jpg", "2/1.jpg"],
      ["https://storage.yandexcloud.net/album-2025/2/2.jpg", "2/2.jpg"],
      ["https://storage.yandexcloud.net/album-2025/2/3.jpg", "2/3.jpg"],
      ["https://storage.yandexcloud.net/album-2025/2/4.jpg", "2/4.jpg"],
      ["https://storage.yandexcloud.net/album-2025/2/5.jpg", "2/5.jpg"],
      ["https://storage.yandexcloud.net/album-2025/2/6.jpg", "2/6.jpg"],
      ["https://storage.yandexcloud.net/album-2025/2/7.jpg", "2/7.jpg"],
    ],
    videos: [
      ["https://storage.yandexcloud.net/album-2025/2/8.mp4", "2/8.mp4"],
      ["https://storage.yandexcloud.net/album-2025/2/9.mp4", "2/9.mp4"],
      ["https://storage.yandexcloud.net/album-2025/2/10.mp4", "2/10.mp4"],
    ]
  },
  {
    title: "Мы начали встречаться",
    text: [
      
    ],
    photos: [
      ["https://storage.yandexcloud.net/album-2025/3/1.jpg", "3/1.jpg"],
      ["https://storage.yandexcloud.net/album-2025/3/2.jpg", "3/2.jpg"],
      ["https://storage.yandexcloud.net/album-2025/3/3.jpg", "3/3.jpg"],
      ["https://storage.yandexcloud.net/album-2025/3/4.jpg", "3/4.jpg"],
      ["https://storage.yandexcloud.net/album-2025/3/5.jpg", "3/5.jpg"],
      ["https://storage.yandexcloud.net/album-2025/3/6.jpg", "3/6.jpg"],
      ["https://storage.yandexcloud.net/album-2025/3/7.jpg", "3/7.jpg"],
      ["https://storage.yandexcloud.net/album-2025/3/8.jpg", "3/8.jpg"],
      ["https://storage.yandexcloud.net/album-2025/3/9.jpg", "3/9.jpg"],
    ],
    videos: [
      ["https://storage.yandexcloud.net/album-2025/3/10.mp4", "3/10.mp4"],
      ["https://storage.yandexcloud.net/album-2025/3/11.mp4", "3/11.mp4"],
      ["https://storage.yandexcloud.net/album-2025/3/12.mp4", "3/12.mp4"],
    ]
  },
  {
    title: "Наш июль",
    text: [
      
    ],
    photos: [
      ["https://storage.yandexcloud.net/album-2025/4/1.jpg", "4/1.jpg"],
      ["https://storage.yandexcloud.net/album-2025/4/2.jpg", "4/2.jpg"],
      ["https://storage.yandexcloud.net/album-2025/4/3.jpg", "4/3.jpg"],
      ["https://storage.yandexcloud.net/album-2025/4/4.jpg", "4/4.jpg"],
      ["https://storage.yandexcloud.net/album-2025/4/5.jpg", "4/5.jpg"],
      ["https://storage.yandexcloud.net/album-2025/4/6.jpg", "4/6.jpg"],
      ["https://storage.yandexcloud.net/album-2025/4/7.jpg", "4/7.jpg"],
      ["https://storage.yandexcloud.net/album-2025/4/8.jpg", "4/8.jpg"],
      ["https://storage.yandexcloud.net/album-2025/4/9.jpg", "4/9.jpg"],
      ["https://storage.yandexcloud.net/album-2025/4/10.jpg", "4/10.jpg"],
      ["https://storage.yandexcloud.net/album-2025/4/11.jpg", "4/11.jpg"],
      ["https://storage.yandexcloud.net/album-2025/4/12.jpg", "4/12.jpg"],
      ["https://storage.yandexcloud.net/album-2025/4/13.jpg", "4/13.jpg"],
      ["https://storage.yandexcloud.net/album-2025/4/14.jpg", "4/14.jpg"],
    ],
    videos: [
      ["https://storage.yandexcloud.net/album-2025/4/15.mp4", "4/15.mp4"],
      ["https://storage.yandexcloud.net/album-2025/4/16.mp4", "4/16.mp4"],
      ["https://storage.yandexcloud.net/album-2025/4/17.mp4", "4/17.mp4"],
      ["https://storage.yandexcloud.net/album-2025/4/18.mp4", "4/18.mp4"],
      ["https://storage.yandexcloud.net/album-2025/4/19.mp4", "4/19.mp4"],
      ["https://storage.yandexcloud.net/album-2025/4/20.mp4", "4/20.mp4"],
      ["https://storage.yandexcloud.net/album-2025/4/21.mp4", "4/21.mp4"],
    ]
  },
  {
    title: "Алтай",
    text: [
      
    ],
    photos: [
      ["https://storage.yandexcloud.net/album-2025/5/1.jpg", "5/1.jpg"],
      ["https://storage.yandexcloud.net/album-2025/5/2.jpg", "5/2.jpg"],
      ["https://storage.yandexcloud.net/album-2025/5/3.jpg", "5/3.jpg"],
      ["https://storage.yandexcloud.net/album-2025/5/4.jpg", "5/4.jpg"],
      ["https://storage.yandexcloud.net/album-2025/5/5.jpg", "5/5.jpg"],
      ["https://storage.yandexcloud.net/album-2025/5/6.jpg", "5/6.jpg"],
      ["https://storage.yandexcloud.net/album-2025/5/7.jpg", "5/7.jpg"],
      ["https://storage.yandexcloud.net/album-2025/5/8.jpg", "5/8.jpg"],
    ],
    videos: []
  },
  {
    title: "Калачинск",
    text: [
      
    ],
    photos: [
      ["https://storage.yandexcloud.net/album-2025/6/1.jpg", "6/1.jpg"],
      ["https://storage.yandexcloud.net/album-2025/6/2.jpg", "6/2.jpg"],
      ["https://storage.yandexcloud.net/album-2025/6/3.jpg", "6/3.jpg"],
      ["https://storage.yandexcloud.net/album-2025/6/4.jpg", "6/4.jpg"],
      ["https://storage.yandexcloud.net/album-2025/6/5.jpg", "6/5.jpg"],
      ["https://storage.yandexcloud.net/album-2025/6/6.jpg", "6/6.jpg"],
      ["https://storage.yandexcloud.net/album-2025/6/7.jpg", "6/7.jpg"],
      ["https://storage.yandexcloud.net/album-2025/6/8.jpg", "6/8.jpg"],
      ["https://storage.yandexcloud.net/album-2025/6/9.jpg", "6/9.jpg"],
      ["https://storage.yandexcloud.net/album-2025/6/10.jpg", "6/10.jpg"],
      ["https://storage.yandexcloud.net/album-2025/6/11.jpg", "6/11.jpg"],
      ["https://storage.yandexcloud.net/album-2025/6/12.jpg", "6/12.jpg"],
    ],
    videos: [
      ["https://storage.yandexcloud.net/album-2025/6/13.mp4", "6/13.mp4"],
    ]
  },
  {
    title: "Последние дни лета",
    text: [
      
    ],
    photos: [
      ["https://storage.yandexcloud.net/album-2025/7/1.jpg", "7/1.jpg"],
      ["https://storage.yandexcloud.net/album-2025/7/2.jpg", "7/2.jpg"],
      ["https://storage.yandexcloud.net/album-2025/7/3.jpg", "7/3.jpg"],
      ["https://storage.yandexcloud.net/album-2025/7/4.jpg", "7/4.jpg"],
      ["https://storage.yandexcloud.net/album-2025/7/5.jpg", "7/5.jpg"],
      ["https://storage.yandexcloud.net/album-2025/7/6.jpg", "7/6.jpg"],
      ["https://storage.yandexcloud.net/album-2025/7/7.jpg", "7/7.jpg"],
      ["https://storage.yandexcloud.net/album-2025/7/8.jpg", "7/8.jpg"],
      ["https://storage.yandexcloud.net/album-2025/7/9.jpg", "7/9.jpg"],
      ["https://storage.yandexcloud.net/album-2025/7/10.jpg", "7/10.jpg"],
      ["https://storage.yandexcloud.net/album-2025/7/11.jpg", "7/11.jpg"],
      ["https://storage.yandexcloud.net/album-2025/7/12.jpg", "7/12.jpg"],
      ["https://storage.yandexcloud.net/album-2025/7/13.jpg", "7/13.jpg"],
      ["https://storage.yandexcloud.net/album-2025/7/14.jpg", "7/14.jpg"],
    ],
    videos: [
      ["https://storage.yandexcloud.net/album-2025/7/15.mp4", "7/15.mp4"],
      ["https://storage.yandexcloud.net/album-2025/7/16.mp4", "7/16.mp4"],
      ["https://storage.yandexcloud.net/album-2025/7/17.MP4", "7/17.MP4"],
      ["https://storage.yandexcloud.net/album-2025/7/18.MP4", "7/18.MP4"],
    ]
  },
  {
    title: "Осень",
    text: [
      
    ],
    photos: [
      ["https://storage.yandexcloud.net/album-2025/8/1.jpg", "8/1.jpg"],
      ["https://storage.yandexcloud.net/album-2025/8/2.jpg", "8/2.jpg"],
      ["https://storage.yandexcloud.net/album-2025/8/3.jpg", "8/3.jpg"],
      ["https://storage.yandexcloud.net/album-2025/8/4.jpg", "8/4.jpg"],
      ["https://storage.yandexcloud.net/album-2025/8/5.jpg", "8/5.jpg"],
      ["https://storage.yandexcloud.net/album-2025/8/6.jpg", "8/6.jpg"],
      ["https://storage.yandexcloud.net/album-2025/8/7.jpg", "8/7.jpg"],
      ["https://storage.yandexcloud.net/album-2025/8/8.jpg", "8/8.jpg"],
      ["https://storage.yandexcloud.net/album-2025/8/9.jpg", "8/9.jpg"],
      ["https://storage.yandexcloud.net/album-2025/8/10.jpg", "8/10.jpg"],
      ["https://storage.yandexcloud.net/album-2025/8/11.jpg", "8/11.jpg"],
      ["https://storage.yandexcloud.net/album-2025/8/12.jpg", "8/12.jpg"],
    ],
    videos: [
      ["https://storage.yandexcloud.net/album-2025/8/13.MP4", "8/13.MP4"],
      ["https://storage.yandexcloud.net/album-2025/8/14.mp4", "8/14.mp4"],
      ["https://storage.yandexcloud.net/album-2025/8/15.mp4", "8/15.mp4"],
      ["https://storage.yandexcloud.net/album-2025/8/16.mp4", "8/16.mp4"],
      ["https://storage.yandexcloud.net/album-2025/8/17.mp4", "8/17.mp4"],
      ["https://storage.yandexcloud.net/album-2025/8/18.mp4", "8/18.mp4"],
      ["https://storage.yandexcloud.net/album-2025/8/19.mp4", "8/19.mp4"],
      ["https://storage.yandexcloud.net/album-2025/8/20.MP4", "8/20.MP4"],
      ["https://storage.yandexcloud.net/album-2025/8/21.MP4", "8/21.MP4"],
      ["https://storage.yandexcloud.net/album-2025/8/22.MP4", "8/22.MP4"],
      ["https://storage.yandexcloud.net/album-2025/8/23.MP4", "8/23.MP4"],
      ["https://storage.yandexcloud.net/album-2025/8/24.MP4", "8/24.MP4"],
      ["https://storage.yandexcloud.net/album-2025/8/25.MP4", "8/25.MP4"],
    ]
  },
  {
    title: "Наша эстетика",
    text: [
      
    ],
    photos: [
      ["https://storage.yandexcloud.net/album-2025/9/1.jpg", "9/1.jpg"],
      ["https://storage.yandexcloud.net/album-2025/9/2.jpg", "9/2.jpg"],
      ["https://storage.yandexcloud.net/album-2025/9/3.jpg", "9/3.jpg"],
      ["https://storage.yandexcloud.net/album-2025/9/4.jpg", "9/4.jpg"],
      ["https://storage.yandexcloud.net/album-2025/9/5.jpg", "9/5.jpg"],
      ["https://storage.yandexcloud.net/album-2025/9/6.jpg", "9/6.jpg"],
      ["https://storage.yandexcloud.net/album-2025/9/7.jpg", "9/7.jpg"],
      ["https://storage.yandexcloud.net/album-2025/9/8.jpg", "9/8.jpg"],
      ["https://storage.yandexcloud.net/album-2025/9/9.jpg", "9/9.jpg"],
      ["https://storage.yandexcloud.net/album-2025/9/10.jpg", "9/10.jpg"],
      ["https://storage.yandexcloud.net/album-2025/9/11.jpg", "9/11.jpg"],
      ["https://storage.yandexcloud.net/album-2025/9/12.jpg", "9/12.jpg"],
      ["https://storage.yandexcloud.net/album-2025/9/13.jpg", "9/13.jpg"],
      ["https://storage.yandexcloud.net/album-2025/9/14.jpg", "9/14.jpg"],
      ["https://storage.yandexcloud.net/album-2025/9/15.jpg", "9/15.jpg"],
      ["https://storage.yandexcloud.net/album-2025/9/16.jpg", "9/16.jpg"],
      ["https://storage.yandexcloud.net/album-2025/9/17.jpg", "9/17.jpg"],
      ["https://storage.yandexcloud.net/album-2025/9/18.jpg", "9/18.jpg"],
      ["https://storage.yandexcloud.net/album-2025/9/19.jpg", "9/19.jpg"],
    ],
    videos: [
      ["https://storage.yandexcloud.net/album-2025/9/20.MP4", "9/20.MP4"],
      ["https://storage.yandexcloud.net/album-2025/9/21.MP4", "9/21.MP4"],
      ["https://storage.yandexcloud.net/album-2025/9/22.MP4", "9/22.MP4"],
    ]
  },
];

/* Helpers */
const el = (tag, cls = "", html = "") => {
  const e = document.createElement(tag);
  if (cls) e.className = cls;
  if (html) e.innerHTML = html;
  return e;
};

/* Определение видеофайлов */
function isVideoFile(src) {
  if (!src) return false;
  const videoExtensions = ['.mp4', '.MP4', '.mov', '.MOV', '.avi', '.webm', '.mkv'];
  const lowerSrc = src.toLowerCase();
  return videoExtensions.some(ext => lowerSrc.endsWith(ext.toLowerCase()));
}

/* Улучшенный Lightbox для мобильных */
const LB = (() => {
  const root = document.getElementById("lightbox");
  const content = root.querySelector(".lb-content");
  const img = root.querySelector(".lb-image");
  const video = root.querySelector(".lb-video");
  const videoSource = video.querySelector("source");
  const btnClose = root.querySelector(".lb-close");
  const btnPrev = root.querySelector(".lb-prev");
  const btnNext = root.querySelector(".lb-next");
  let items = [],
    idx = 0,
    isAnimating = false,
    isMobile = window.innerWidth <= 768,
    touchStartX = 0,
    touchEndX = 0;

  // Обновляем isMobile при ресайзе
  window.addEventListener('resize', () => {
    isMobile = window.innerWidth <= 768;
  });

  function open(itemsArray, i) {
    items = itemsArray.slice();
    idx = i;
    showItem();
    root.classList.remove("hidden");
    document.body.style.overflow = "hidden";
    document.documentElement.style.overflow = "hidden";
    
    // Добавляем класс для тач-устройств
    if (isMobile) {
      root.classList.add('touch-active');
    }
  }
  
  function close() {
    root.classList.add("hidden");
    img.src = "";
    videoSource.src = "";
    video.classList.add("hidden");
    img.classList.add("hidden");
    video.pause();
    document.body.style.overflow = "";
    document.documentElement.style.overflow = "";
    
    // Удаляем класс для тач-устройств
    root.classList.remove('touch-active');
  }
  
  function prev() {
    if (isAnimating) return;
    idx = (idx - 1 + items.length) % items.length;
    showItemWithAnimation();
    
    // На мобильных временно скрываем стрелки при клике
    if (isMobile) {
      btnPrev.style.opacity = '0.3';
      btnNext.style.opacity = '0.3';
      setTimeout(() => {
        btnPrev.style.opacity = '';
        btnNext.style.opacity = '';
      }, 300);
    }
  }
  
  function next() {
    if (isAnimating) return;
    idx = (idx + 1) % items.length;
    showItemWithAnimation();
    
    // На мобильных временно скрываем стрелки при клике
    if (isMobile) {
      btnPrev.style.opacity = '0.3';
      btnNext.style.opacity = '0.3';
      setTimeout(() => {
        btnPrev.style.opacity = '';
        btnNext.style.opacity = '';
      }, 300);
    }
  }
  
  function showItem() {
    const currentItem = items[idx];
    const isVideo = currentItem.type === "video" || isVideoFile(currentItem.src);
    
    if (isVideo) {
      img.classList.add("hidden");
      
      setTimeout(() => {
        video.classList.remove("hidden");
        videoSource.src = currentItem.src || currentItem;
        video.load();
        
        // На iOS предотвращаем автоматическое полноэкранное воспроизведение
        if (isMobile) {
          video.setAttribute('playsinline', 'true');
          video.setAttribute('webkit-playsinline', 'true');
          video.setAttribute('controls', 'true');
        }
        
        video.play().catch(e => {
          console.log("Автовоспроизведение заблокировано");
        });
      }, 50);
    } else {
      video.classList.add("hidden");
      video.pause();
      
      setTimeout(() => {
        img.classList.remove("hidden");
        img.src = currentItem.src || currentItem;
        img.alt = `Фото ${idx + 1} из ${items.length}`;
      }, 50);
    }
  }
  
  function showItemWithAnimation() {
    if (isAnimating) return;
    isAnimating = true;
    
    content.style.opacity = "0";
    
    setTimeout(() => {
      showItem();
      
      setTimeout(() => {
        content.style.opacity = "1";
        isAnimating = false;
      }, 100);
    }, 200);
  }

  // Обработка свайпов на мобильных
  function handleTouchStart(e) {
    if (!isMobile) return;
    touchStartX = e.changedTouches[0].screenX;
  }
  
  function handleTouchEnd(e) {
    if (!isMobile || isAnimating) return;
    touchEndX = e.changedTouches[0].screenX;
    handleSwipe();
  }
  
  function handleSwipe() {
    const minSwipeDistance = 50;
    const distance = touchStartX - touchEndX;
    
    if (Math.abs(distance) < minSwipeDistance) return;
    
    if (distance > 0) {
      next();
    } else {
      prev();
    }
  }

  btnClose.addEventListener("click", close);
  btnPrev.addEventListener("click", (e) => {
    e.preventDefault();
    e.stopPropagation();
    prev();
  });
  btnNext.addEventListener("click", (e) => {
    e.preventDefault();
    e.stopPropagation();
    next();
  });
  
  // Предотвращаем всплытие событий на мобильных
  if (isMobile) {
    btnPrev.addEventListener('touchstart', (e) => {
      e.preventDefault();
      e.stopPropagation();
      btnPrev.style.opacity = '0.3';
    });
    
    btnPrev.addEventListener('touchend', (e) => {
      e.preventDefault();
      e.stopPropagation();
      prev();
      setTimeout(() => {
        btnPrev.style.opacity = '';
      }, 300);
    });
    
    btnNext.addEventListener('touchstart', (e) => {
      e.preventDefault();
      e.stopPropagation();
      btnNext.style.opacity = '0.3';
    });
    
    btnNext.addEventListener('touchend', (e) => {
      e.preventDefault();
      e.stopPropagation();
      next();
      setTimeout(() => {
        btnNext.style.opacity = '';
      }, 300);
    });
  }
  
  root.addEventListener("click", (e) => {
    if (e.target === root) close();
  });
  
  // Добавляем обработчики свайпов
  root.addEventListener('touchstart', handleTouchStart, { passive: true });
  root.addEventListener('touchend', handleTouchEnd, { passive: true });
  
  document.addEventListener("keydown", (e) => {
    if (root.classList.contains("hidden")) return;
    if (e.key === "Escape") close();
    if (e.key === "ArrowLeft") prev();
    if (e.key === "ArrowRight") next();
  });
  
  // Инициализация прозрачности контента
  content.style.transition = "opacity 0.3s ease";
  content.style.opacity = "1";
  
  // Скрываем стрелки на мобильных через несколько секунд
  let hideTimer;
  function hideArrowsOnMobile() {
    if (!isMobile) return;
    
    clearTimeout(hideTimer);
    btnPrev.style.opacity = '1';
    btnNext.style.opacity = '1';
    btnClose.style.opacity = '1';
    
    hideTimer = setTimeout(() => {
      btnPrev.style.opacity = '0.3';
      btnNext.style.opacity = '0.3';
      btnClose.style.opacity = '0.7';
    }, 2000);
  }
  
  root.addEventListener('mousemove', hideArrowsOnMobile);
  root.addEventListener('touchstart', hideArrowsOnMobile);
  
  return { open, close };
})();

/* Система летающих сердечек - РАБОТАЕТ НА ВСЕХ УСТРОЙСТВАХ */
function createHeartsSystem() {
  let heartCount = 0;
  const maxHearts = window.innerWidth <= 768 ? 15 : 10; // Больше сердечек на мобильных
  
  // SVG для сердечка
  const heartSVG = `<svg viewBox="0 0 32 29" xmlns="http://www.w3.org/2000/svg">
    <path d="M23.6,0c-3.4,0-6.3,2.7-7.6,5.6C14.7,2.7,11.8,0,8.4,0C3.8,0,0,3.8,0,8.4c0,9.4,9.5,11.9,16,21.2
      c6.1-9.3,16-12.1,16-21.2C32,3.8,28.2,0,23.6,0z" fill="currentColor"/>
  </svg>`;
  
  function createHeart() {
    if (heartCount >= maxHearts) return;
    
    heartCount++;
    
    const heart = document.createElement('div');
    heart.className = 'heart';
    
    // Разные размеры для мобильных и десктопа
    const size = window.innerWidth <= 768 
      ? 15 + Math.random() * 15 // 15-30px на мобильных
      : 20 + Math.random() * 25; // 20-45px на десктопе
    
    heart.style.width = `${size}px`;
    heart.style.height = `${size}px`;
    
    // Цвета сердечек
    const colors = [
      '#ff6bcb', '#ff8ac7', '#ffa8c3', '#ffc6bf', 
      '#ffe4f0', '#ffd1e0', '#ffb8d0', '#ff9fc0',
      '#ff6bd0', '#ff8ad0'
    ];
    const color = colors[Math.floor(Math.random() * colors.length)];
    heart.style.color = color;
    
    // Случайная начальная позиция внизу экрана
    const startX = Math.random() * window.innerWidth;
    
    // Разные анимации
    const animations = ['floatHeart', 'floatHeart2', 'floatHeart3'];
    const animation = animations[Math.floor(Math.random() * animations.length)];
    
    // Разная скорость на разных устройствах
    const duration = window.innerWidth <= 768
      ? 4 + Math.random() * 4 // 4-8 секунд на мобильных
      : 6 + Math.random() * 6; // 6-12 секунд на десктопе
    
    // Устанавливаем стили
    heart.style.position = 'fixed';
    heart.style.left = `${startX}px`;
    heart.style.top = `${window.innerHeight}px`;
    heart.style.zIndex = '1';
    heart.style.pointerEvents = 'none';
    heart.style.animation = `${animation} ${duration}s linear forwards`;
    heart.style.opacity = '0';
    
    // Добавляем SVG сердечко
    heart.innerHTML = heartSVG;
    
    // Добавляем сердечко в DOM
    document.body.appendChild(heart);
    
    // Удаляем сердечко после анимации
    setTimeout(() => {
      if (heart.parentNode) {
        heart.remove();
        heartCount--;
      }
    }, duration * 1000);
  }
  
  // Создаем начальные сердечки
  const initialHearts = window.innerWidth <= 768 ? 8 : 5;
  for (let i = 0; i < initialHearts; i++) {
    setTimeout(() => createHeart(), i * (window.innerWidth <= 768 ? 400 : 600));
  }
  
  // Периодически добавляем новые сердечки
  const heartInterval = setInterval(() => {
    if (document.hidden) return;
    createHeart();
  }, window.innerWidth <= 768 ? 800 : 1200);
  
  // Сохраняем интервал для очистки
  window.heartInterval = heartInterval;
  
  // Обновляем параметры при ресайзе
  window.addEventListener('resize', () => {
    clearInterval(heartInterval);
    
    // Удаляем существующие сердечки
    document.querySelectorAll('.heart').forEach(heart => {
      heart.remove();
    });
    
    // Перезапускаем систему с новыми параметрами
    setTimeout(createHeartsSystem, 100);
  });
}

/* Slider с правильной адаптивностью и анимацией в обе стороны */
class Slider {
  constructor(photos, videos, mount) {
    // ФИКС: Используем относительные пути для GitHub Pages
    // Обрабатываем массивы источников для каждого медиафайла
    this.allItems = [
      ...photos.map(srcArray => ({ 
        src: this.fixPath(srcArray[0]), // Берем первый источник как основной
        sources: srcArray.map(src => this.fixPath(src)), // Все источники
        type: "image" 
      })),
      ...(videos || []).map(srcArray => ({ 
        src: this.fixPath(srcArray[0]), // Берем первый источник как основной
        sources: srcArray.map(src => this.fixPath(src)), // Все источники
        type: "video" 
      }))
    ];
    
    this.mount = mount;
    this.current = 0;
    this.isAnimating = false;
    this.loadedCount = 0;
    this.totalToLoad = this.allItems.length;
    this.maxDisplayHeight = 0;
    this.isMobile = window.innerWidth <= 768;
    
    // Для отслеживания направления анимации
    this.direction = 'right'; // 'right' или 'left'
    
    // Для отслеживания ошибок
    this.errorCount = 0;

    // Обновляем isMobile при ресайзе
    window.addEventListener('resize', () => {
      this.isMobile = window.innerWidth <= 768;
      this.updateSliderForMobile();
    });

    this.wrapper = el("div", "slider-wrapper");
    this.viewport = el("div", "slider-viewport");
    this.track = el("div", "track");
    this.wrapper.appendChild(this.viewport);
    this.viewport.appendChild(this.track);

    // Стрелки только для десктопа
    if (!this.isMobile) {
      this.prevBtn = el("button", "slider-button prev", "◀");
      this.nextBtn = el("button", "slider-button next", "▶");
      this.prevBtn.setAttribute("aria-label", "Предыдущее фото");
      this.nextBtn.setAttribute("aria-label", "Следующее фото");
      this.wrapper.appendChild(this.prevBtn);
      this.wrapper.appendChild(this.nextBtn);
    }

    this.mount.appendChild(this.wrapper);

    this.slides = [];
    
    this.buildSlides();
    this.startLoadingAndCalculateHeight();
    this.updateSliderForMobile();
  }

  // ФИКС: Исправляем пути для GitHub Pages
  fixPath(path) {
    // Убираем начальный слеш, если он есть
    if (path.startsWith('/')) {
      path = path.substring(1);
    }
    
    return path;
  }

  updateSliderForMobile() {
    if (this.isMobile) {
      // Убираем рамку и фон на мобильных
      this.wrapper.style.border = 'none';
      this.wrapper.style.background = 'transparent';
      this.wrapper.style.boxShadow = 'none';
      this.wrapper.style.padding = '0';
      this.wrapper.style.borderRadius = '0';
      
      // Убираем стрелки если они есть
      if (this.prevBtn && this.nextBtn) {
        this.prevBtn.style.display = 'none';
        this.nextBtn.style.display = 'none';
      }
      
      // Добавляем свайпы для мобильных
      this.addSwipeSupport();
    } else {
      // Восстанавливаем стили для десктопа
      this.wrapper.style.border = '2px solid rgba(255, 228, 240, 0.35)';
      this.wrapper.style.background = '#181818';
      this.wrapper.style.boxShadow = '0 8px 20px rgba(0, 0, 0, 0.4)';
      this.wrapper.style.padding = '16px';
      this.wrapper.style.borderRadius = '18px';
      
      // Показываем стрелки если они есть
      if (this.prevBtn && this.nextBtn) {
        this.prevBtn.style.display = 'flex';
        this.nextBtn.style.display = 'flex';
      }
    }
  }

  addSwipeSupport() {
    let touchStartX = 0;
    let touchEndX = 0;
    
    const handleTouchStart = (e) => {
      touchStartX = e.changedTouches[0].screenX;
    };
    
    const handleTouchEnd = (e) => {
      if (this.isAnimating) return;
      touchEndX = e.changedTouches[0].screenX;
      handleSwipe();
    };
    
    const handleSwipe = () => {
      const minSwipeDistance = 50;
      const distance = touchStartX - touchEndX;
      
      if (Math.abs(distance) < minSwipeDistance) return;
      
      if (distance > 0) {
        this.direction = 'right';
        this.goTo((this.current + 1) % this.allItems.length);
      } else {
        this.direction = 'left';
        this.goTo((this.current - 1 + this.allItems.length) % this.allItems.length);
      }
    };
    
    this.track.addEventListener('touchstart', handleTouchStart, { passive: true });
    this.track.addEventListener('touchend', handleTouchEnd, { passive: true });
  }

  buildSlides() {
    this.track.innerHTML = "";
    this.allItems.forEach((item, i) => {
      const s = el("div", "slide");
      
      if (item.type === "video") {
        const video = el("video");
        
        // Пробуем загручить видео из доступных источников
        this.loadVideoWithFallback(video, item.sources, s);
        
        video.controls = true;
        video.setAttribute("playsinline", "true");
        video.setAttribute("webkit-playsinline", "true");
        video.setAttribute("preload", "metadata");
        video.setAttribute("aria-label", `Видео ${i + 1} из ${this.allItems.length}`);
        
        s.appendChild(video);
      } else {
        const img = el("img");
        
        // Пробуем загручить изображение из доступных источников
        this.loadImageWithFallback(img, item.sources, s);
        
        img.loading = "lazy";
        img.setAttribute("alt", `Фото ${i + 1} из ${this.allItems.length}`);
        
        s.appendChild(img);
      }
      
      const num = el("div", "slide-number", `${i + 1}/${this.allItems.length}`);
      s.appendChild(num);
      this.slides.push(s);
      this.track.appendChild(s);
    });
  }

  // Функция для загрузки изображения с fallback
  loadImageWithFallback(img, sources, container) {
    let currentIndex = 0;
    
    const tryNextSource = () => {
      if (currentIndex >= sources.length) {
        // Все источники не загрузились
        img.style.display = 'none';
        const errorMsg = el("div", "", `❌ Фото не загружено`);
        errorMsg.style.color = '#ff6b6b';
        errorMsg.style.padding = '20px';
        errorMsg.style.textAlign = 'center';
        container.appendChild(errorMsg);
        
        this.errorCount++;
        this.loadedCount++;
        window.updateGlobalLoadingProgress(this.loadedCount, this.totalToLoad, true);
        return;
      }
      
      img.src = sources[currentIndex];
      
      img.onload = () => {
        if (!this.isMobile) {
          this.calculateDisplayHeight(img, false, currentIndex);
        }
        this.loadedCount++;
        window.updateGlobalLoadingProgress(this.loadedCount, this.totalToLoad, false);
      };
      
      img.onerror = () => {
        console.warn(`Не удалось загручить фото из источника ${currentIndex}: ${sources[currentIndex]}`);
        currentIndex++;
        tryNextSource();
      };
    };
    
    tryNextSource();
  }

  // Функция для загрузки видео с fallback
  loadVideoWithFallback(video, sources, container) {
    let currentIndex = 0;
    
    const tryNextSource = () => {
      if (currentIndex >= sources.length) {
        // Все источники не загрузились
        video.style.display = 'none';
        const errorMsg = el("div", "", `❌ Видео не загружено`);
        errorMsg.style.color = '#ff6b6b';
        errorMsg.style.padding = '20px';
        errorMsg.style.textAlign = 'center';
        container.appendChild(errorMsg);
        
        this.errorCount++;
        this.loadedCount++;
        window.updateGlobalLoadingProgress(this.loadedCount, this.totalToLoad, true);
        return;
      }
      
      video.src = sources[currentIndex];
      
      video.onloadedmetadata = () => {
        if (!this.isMobile) {
          this.calculateDisplayHeight(video, true, currentIndex);
        }
        this.loadedCount++;
        window.updateGlobalLoadingProgress(this.loadedCount, this.totalToLoad, false);
      };
      
      video.onerror = () => {
        console.warn(`Не удалось загручить видео из источника ${currentIndex}: ${sources[currentIndex]}`);
        currentIndex++;
        tryNextSource();
      };
    };
    
    tryNextSource();
  }

  startLoadingAndCalculateHeight() {
    // Создаем промисы для каждого элемента
    const loadPromises = this.allItems.map((item, index) => {
      return new Promise((resolve) => {
        if (item.type === "video") {
          const video = document.createElement("video");
          video.preload = "metadata";
          
          // Пробуем загручить из доступных источников
          let currentSourceIndex = 0;
          
          const tryLoadVideo = () => {
            if (currentSourceIndex >= item.sources.length) {
              // Все источники не загрузились
              this.errorCount++;
              this.loadedCount++;
              window.updateGlobalLoadingProgress(this.loadedCount, this.totalToLoad, true);
              resolve();
              return;
            }
            
            video.src = item.sources[currentSourceIndex];
            
            video.onloadedmetadata = () => {
              if (!this.isMobile) {
                this.calculateDisplayHeight(video, true, index);
              }
              this.loadedCount++;
              window.updateGlobalLoadingProgress(this.loadedCount, this.totalToLoad, false);
              resolve();
            };
            
            video.onerror = () => {
              console.warn(`Не удалось загручить видео (метаданные) из источника ${currentSourceIndex}: ${item.sources[currentSourceIndex]}`);
              currentSourceIndex++;
              tryLoadVideo();
            };
          };
          
          tryLoadVideo();
        } else {
          const img = new Image();
          
          // Пробуем загручить из доступных источников
          let currentSourceIndex = 0;
          
          const tryLoadImage = () => {
            if (currentSourceIndex >= item.sources.length) {
              // Все источники не загрузились
              this.errorCount++;
              this.loadedCount++;
              window.updateGlobalLoadingProgress(this.loadedCount, this.totalToLoad, true);
              resolve();
              return;
            }
            
            img.src = item.sources[currentSourceIndex];
            
            img.onload = () => {
              if (!this.isMobile) {
                this.calculateDisplayHeight(img, false, index);
              }
              this.loadedCount++;
              window.updateGlobalLoadingProgress(this.loadedCount, this.totalToLoad, false);
              resolve();
            };
            
            img.onerror = () => {
              console.warn(`Не удалось загручить фото из источника ${currentSourceIndex}: ${item.sources[currentSourceIndex]}`);
              currentSourceIndex++;
              tryLoadImage();
            };
          };
          
          tryLoadImage();
        }
      });
    });

    // Когда все промисы завершены
    Promise.all(loadPromises).then(() => {
      console.log(`Слайдер загружен: ${this.loadedCount}/${this.totalToLoad} элементов, ошибок: ${this.errorCount}`);
      
      if (!this.isMobile) {
        this.setFinalHeight();
      } else {
        // На мобильных устанавливаем минимальную высоту
        this.wrapper.style.height = 'auto';
        this.wrapper.style.minHeight = '250px';
      }
      
      this.update();
      this.bind();
      
      // Отмечаем, что этот слайдер полностью загружен
      window.incrementLoadedSliders();
    });
  }

  calculateDisplayHeight(element, isVideo, index) {
    try {
      const originalWidth = isVideo ? element.videoWidth : element.naturalWidth;
      const originalHeight = isVideo ? element.videoHeight : element.naturalHeight;
      
      if (originalWidth === 0 || originalHeight === 0) return;
      
      const ratio = originalHeight / originalWidth;
      const sliderMaxWidth = this.wrapper.clientWidth * 0.92;
      let displayHeight = sliderMaxWidth * ratio;
      
      const maxAllowedHeight = window.innerHeight * 0.6;
      
      displayHeight = Math.min(displayHeight, maxAllowedHeight);
      this.maxDisplayHeight = Math.max(this.maxDisplayHeight, displayHeight);
    } catch (error) {
      console.warn(`Ошибка при расчете высоты: ${error.message}`);
    }
  }

  setFinalHeight() {
    try {
      const padding = 32;
      const slideNumberHeight = 40;
      const finalHeight = this.maxDisplayHeight + padding + slideNumberHeight;
      const minHeight = 300;
      
      this.wrapper.style.height = Math.max(finalHeight, minHeight) + "px";
      this.wrapper.classList.add('visible');
    } catch (error) {
      console.warn(`Ошибка при установке высоты: ${error.message}`);
      this.wrapper.style.height = 'auto';
      this.wrapper.style.minHeight = '300px';
    }
  }

  bind() {
    if (!this.isMobile && this.prevBtn && this.nextBtn) {
      this.prevBtn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (this.isAnimating) return;
        this.direction = 'left';
        this.goTo((this.current - 1 + this.allItems.length) % this.allItems.length);
      });
      
      this.nextBtn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (this.isAnimating) return;
        this.direction = 'right';
        this.goTo((this.current + 1) % this.allItems.length);
      });
    }
    
    this.track.addEventListener("click", (e) => {
      // На мобильных предотвращаем открытие лайтбокса при свайпе
      if (this.isMobile) {
        const target = e.target;
        if (target.tagName === 'VIDEO' || target.closest('video')) {
          // Для видео открываем лайтбокс
          e.preventDefault();
          const idx = Array.from(this.slides).indexOf(e.target.closest(".slide"));
          if (idx !== -1) {
            LB.open(this.allItems, idx);
          }
        } else if (target.tagName === 'IMG' || target.closest('img')) {
          // Для изображений открываем лайтбокс
          e.preventDefault();
          const idx = Array.from(this.slides).indexOf(e.target.closest(".slide"));
          if (idx !== -1) {
            LB.open(this.allItems, idx);
          }
        }
      } else {
        // На десктопе обычное поведение
        const s = e.target.closest(".slide");
        if (!s) return;
        const idx = this.slides.indexOf(s);
        LB.open(this.allItems, idx);
      }
    });
  }

  goTo(index) {
    if (this.isAnimating || index === this.current) return;
    
    this.isAnimating = true;
    const oldIndex = this.current;
    this.current = index;
    
    // Убираем активный класс у текущего слайда
    this.slides[oldIndex].classList.remove("active");
    
    // Добавляем класс анимации выхода с учетом направления
    if (this.direction === 'right') {
      this.slides[oldIndex].classList.remove("exit-left");
      this.slides[oldIndex].classList.add("exit-right");
    } else {
      this.slides[oldIndex].classList.remove("exit-right");
      this.slides[oldIndex].classList.add("exit-left");
    }
    
    setTimeout(() => {
      this.slides[oldIndex].style.display = "none";
      this.slides[oldIndex].classList.remove("exit-right", "exit-left");
      
      this.slides[this.current].style.display = "flex";
      
      setTimeout(() => {
        this.slides[this.current].classList.add("active");
        this.isAnimating = false;
      }, 50);
    }, 300);
  }

  update() {
    this.slides.forEach((s, i) => {
      s.style.display = i === this.current ? "flex" : "none";
      if (i === this.current) {
        setTimeout(() => {
          s.classList.add("active");
        }, 50);
      } else {
        s.classList.remove("active");
      }
    });
    
    // Показываем обертку
    this.wrapper.classList.add('visible');
  }
}

/* Анимация обложки при прокрутке - ИСПРАВЛЕНО */
function setupHeroScrollAnimation() {
  const hero = document.getElementById('hero');
  const heroBg = document.getElementById('heroBg');
  const heroContent = document.querySelector('.hero-content');
  const heroWe = document.querySelector('.hero-we');
  const heroYear = document.querySelector('.hero-year');
  
  // Инициализируем начальное состояние
  hero.classList.remove('hero-scrolled', 'hero-hidden');
  heroBg.style.transform = 'scale(1)';
  heroBg.style.filter = 'brightness(0.86) saturate(1.1)';
  heroContent.style.opacity = '1';
  heroContent.style.transform = 'translateY(0) scale(1)';
  
  function handleScroll() {
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    const heroHeight = hero.offsetHeight;
    const scrollPercent = Math.min(scrollTop / heroHeight, 1);
    
    // Параллакс эффект для фона
    const parallaxOffset = scrollTop * 0.5;
    heroBg.style.transform = `scale(${1 + scrollPercent * 0.12}) translateY(${parallaxOffset * 0.2}px)`;
    
    // Плавное изменение фильтров
    const brightness = 0.86 - (scrollPercent * 0.56);
    const blur = scrollPercent * 4;
    const saturate = 1.1 - (scrollPercent * 0.5);
    
    heroBg.style.filter = `brightness(${brightness}) saturate(${saturate}) blur(${blur}px)`;
    
    // Плавное изменение прозрачности контента
    heroContent.style.opacity = `${1 - scrollPercent * 0.7}`;
    heroContent.style.transform = `translateY(${-scrollPercent * 40}px) scale(${1 - scrollPercent * 0.04})`;
    
    // Изменение тени текста
    const textShadowOpacity = 0.6 - (scrollPercent * 0.5);
    const textShadowBlur = 30 - (scrollPercent * 25);
    
    heroWe.style.textShadow = `0 0 ${textShadowBlur}px rgba(255, 228, 240, ${textShadowOpacity})`;
    heroYear.style.textShadow = `0 0 ${textShadowBlur * 0.7}px rgba(255, 228, 240, ${textShadowOpacity})`;
    
    // Добавляем/убираем классы для триггерных точек
    if (scrollPercent > 0.8) {
      hero.classList.remove('hero-scrolled');
      hero.classList.add('hero-hidden');
    } else if (scrollPercent > 0.2) {
      hero.classList.add('hero-scrolled');
      hero.classList.remove('hero-hidden');
    } else {
      hero.classList.remove('hero-scrolled');
      hero.classList.remove('hero-hidden');
    }
    
    // Индикатор прокрутки
    const scrollIndicator = document.querySelector('.scroll-indicator');
    if (scrollIndicator) {
      scrollIndicator.style.opacity = `${0.8 - scrollPercent}`;
    }
  }
  
  // Добавляем обработчики событий
  window.addEventListener('scroll', handleScroll, { passive: true });
  window.addEventListener('resize', handleScroll, { passive: true });
  
  // Запускаем сразу для инициализации
  setTimeout(handleScroll, 100);
  
  // Эффект параллакса при движении мыши (только на десктопе)
  if (window.innerWidth > 768) {
    document.addEventListener('mousemove', (e) => {
      if (hero.classList.contains('hero-hidden')) return;
      
      const mouseX = e.clientX / window.innerWidth;
      const mouseY = e.clientY / window.innerHeight;
      
      const moveX = (mouseX - 0.5) * 20;
      const moveY = (mouseY - 0.5) * 20;
      
      heroBg.style.transform = `scale(1.05) translate(${moveX}px, ${moveY}px)`;
    });
    
    // Сбрасываем позицию при уходе мыши
    document.addEventListener('mouseleave', () => {
      if (!hero.classList.contains('hero-hidden')) {
        heroBg.style.transform = 'scale(1.05)';
      }
    });
  }
}

/* Система появления элементов при скролле */
function setupScrollReveal() {
  let ticking = false;
  
  function checkVisibility() {
    if (ticking) return;
    
    ticking = true;
    
    requestAnimationFrame(() => {
      const elements = document.querySelectorAll('.memory-section, .section-divider, .fade-in, .slider-wrapper');
      const windowHeight = window.innerHeight;
      
      const triggerPoint = windowHeight * 0.15;
      
      elements.forEach((element, index) => {
        const rect = element.getBoundingClientRect();
        
        const isVisible = rect.top < windowHeight - triggerPoint;
        
        if (isVisible && !element.classList.contains('visible')) {
          setTimeout(() => {
            element.classList.add('visible');
          }, Math.min(index * 30, 200));
        }
      });
      
      ticking = false;
    });
  }
  
  setTimeout(checkVisibility, 100);
  
  window.addEventListener('scroll', () => {
    checkVisibility();
  }, { passive: true });
  
  window.addEventListener('resize', checkVisibility, { passive: true });
  
  setInterval(checkVisibility, 300);
}

/* Музыкальный плеер с мини-плеером */
function setupMusicPlayer() {
  const audio = document.getElementById('backgroundMusic');
  const playPauseBtn = document.getElementById('playPauseBtn');
  const muteBtn = document.getElementById('muteBtn');
  const volumeSlider = document.getElementById('volumeSlider');
  const closePlayerBtn = document.getElementById('closePlayerBtn');
  const musicPlayer = document.getElementById('musicPlayer');
  const miniPlayer = document.getElementById('miniPlayer');
  const miniPlayerBtn = document.getElementById('miniPlayerBtn');
  
  let isPlaying = false;
  let isMuted = false;
  let lastVolume = 0.3;
  
  // ФИКС: Проверяем и исправляем путь к музыке для GitHub Pages
  const audioSources = audio.querySelectorAll('source');
  audioSources.forEach(source => {
    const originalSrc = source.src;
    if (originalSrc && !originalSrc.includes('http')) {
      const fixedSrc = originalSrc.startsWith('/') ? originalSrc.substring(1) : originalSrc;
      source.src = fixedSrc;
    }
  });
  
  // Перезагружаем audio элемент с новыми путями
  audio.load();
  
  audio.volume = lastVolume;
  
  function checkAudioSupport() {
    const canPlayMP3 = audio.canPlayType('audio/mp3');
    const canPlayOGG = audio.canPlayType('audio/ogg');
    
    if (!canPlayMP3 && !canPlayOGG) {
      musicPlayer.style.display = 'none';
      miniPlayer.style.display = 'none';
      return false;
    }
    return true;
  }
  
  function updatePlayButton() {
    const icon = isPlaying ? 'fa-pause' : 'fa-play';
    playPauseBtn.innerHTML = `<i class="fas ${icon}"></i>`;
  }
  
  function updateMuteButton() {
    let icon;
    if (isMuted) {
      icon = 'fa-volume-mute';
    } else if (audio.volume >= 0.5) {
      icon = 'fa-volume-up';
    } else if (audio.volume > 0) {
      icon = 'fa-volume-down';
    } else {
      icon = 'fa-volume-off';
    }
    muteBtn.innerHTML = `<i class="fas ${icon}"></i>`;
  }
  
  function togglePlayPause() {
    if (isPlaying) {
      audio.pause();
    } else {
      audio.play().catch(e => {
        playPauseBtn.style.animation = 'none';
        setTimeout(() => {
          playPauseBtn.style.animation = 'pulse 1s ease-in-out';
        }, 10);
      });
    }
    isPlaying = !isPlaying;
    updatePlayButton();
  }
  
  function toggleMute() {
    if (isMuted) {
      audio.volume = lastVolume;
      volumeSlider.value = lastVolume;
      isMuted = false;
    } else {
      lastVolume = audio.volume;
      audio.volume = 0;
      volumeSlider.value = 0;
      isMuted = true;
    }
    updateMuteButton();
  }
  
  function changeVolume() {
    const volume = parseFloat(volumeSlider.value);
    audio.volume = volume;
    
    if (volume === 0) {
      isMuted = true;
    } else {
      isMuted = false;
      lastVolume = volume;
    }
    
    updateMuteButton();
  }
  
  function togglePlayer() {
    if (musicPlayer.classList.contains('hidden')) {
      musicPlayer.classList.remove('hidden');
      miniPlayer.style.display = 'none';
    } else {
      musicPlayer.classList.add('hidden');
      miniPlayer.style.display = 'block';
    }
  }
  
  function closePlayer() {
    musicPlayer.classList.add('hidden');
    miniPlayer.style.display = 'block';
  }
  
  if (checkAudioSupport()) {
    // Добавляем обработчики с preventDefault для мобильных
    const addSafeClickListener = (element, handler) => {
      element.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        handler();
      });
      
      element.addEventListener('touchstart', (e) => {
        if (e.cancelable) {
          e.preventDefault();
        }
      }, { passive: false });
      
      element.addEventListener('touchend', (e) => {
        e.preventDefault();
        e.stopPropagation();
        handler();
      });
    };
    
    addSafeClickListener(playPauseBtn, togglePlayPause);
    addSafeClickListener(muteBtn, toggleMute);
    addSafeClickListener(closePlayerBtn, closePlayer);
    addSafeClickListener(miniPlayerBtn, togglePlayer);
    
    volumeSlider.addEventListener('input', changeVolume);
    volumeSlider.addEventListener('touchstart', (e) => {
      e.stopPropagation();
    }, { passive: true });
    
    audio.addEventListener('play', () => {
      isPlaying = true;
      updatePlayButton();
    });
    
    audio.addEventListener('pause', () => {
      isPlaying = false;
      updatePlayButton();
    });
    
    audio.addEventListener('volumechange', updateMuteButton);
    
    audio.addEventListener('error', (e) => {
      const trackInfo = document.querySelector('.track-info');
      if (trackInfo) {
        trackInfo.innerHTML = '<div class="track-title" style="color:#ff6b6b">Музыка не загружена</div>';
      }
    });
    
    // Скрываем полноценный плеер, показываем мини-плеер
    musicPlayer.classList.add('hidden');
    miniPlayer.style.display = 'block';
    
    // Автовоспроизведение с задержкой
    setTimeout(() => {
      audio.play().catch(e => {});
    }, 2000);
    
    // Инициализация иконок
    updatePlayButton();
    updateMuteButton();
  }
}

/* Render sections */
function renderSections() {
  const root = document.getElementById("sections");
  sectionsData.forEach((sec, idx) => {
    const section = el("section", "memory-section");
    const title = el("h3", "sparkle-title", sec.title);
    section.appendChild(title);
    
    const mount = el("div", "slider-mount");
    section.appendChild(mount);
    
    const textContainer = el("div", "section-text");
    sec.text.forEach(paragraph => {
      if (paragraph.trim()) {
        const p = el("p", "", paragraph);
        textContainer.appendChild(p);
      }
    });
    if (textContainer.children.length > 0) {
      section.appendChild(textContainer);
    }
    
    root.appendChild(section);
    new Slider(sec.photos, sec.videos || [], mount);

    // Добавляем разделительную полоску ТОЛЬКО между секциями, не после последней
    if (idx !== sectionsData.length - 1) {
      const divider = el("div", "section-divider");
      root.appendChild(divider);
    }
  });
}

/* Глобальный счетчик загрузки медиафайлов */
window.globalLoadingState = {
  totalMediaFiles: 0,
  loadedMediaFiles: 0,
  totalSliders: sectionsData.length,
  loadedSliders: 0,
  heroImageLoaded: false,
  allSlidersReady: false
};

// Считаем общее количество медиафайлов
function calculateTotalMediaFiles() {
  let total = 0;
  sectionsData.forEach(sec => {
    total += sec.photos.length + (sec.videos ? sec.videos.length : 0);
  });
  return total;
}

window.globalLoadingState.totalMediaFiles = calculateTotalMediaFiles();

// Общий счетчик для прогресса
let totalMediaLoaded = 0;

/* Обновление прогресса загрузки */
window.updateGlobalLoadingProgress = function(loaded, total, isError) {
  const state = window.globalLoadingState;
  
  // Обновляем счетчик
  if (loaded !== undefined) {
    totalMediaLoaded = loaded;
  }
  
  // Рассчитываем процент
  const percent = Math.round((totalMediaLoaded / state.totalMediaFiles) * 100);
  
  // Обновляем текст загрузки
  const loadingText = document.querySelector('.loading-text');
  if (loadingText) {
    loadingText.textContent = `Загрузка воспоминаний... ${percent}%`;
  }
  
  // Проверяем, все ли загружено
  const allLoaded = state.heroImageLoaded && 
                    state.loadedSliders >= state.totalSliders;
  
  if (allLoaded && !state.allSlidersReady) {
    state.allSlidersReady = true;
    setTimeout(() => {
      window.hidePreloader();
    }, 500);
  }
};

/* Увеличение счетчика загруженных слайдеров */
window.incrementLoadedSliders = function() {
  const state = window.globalLoadingState;
  state.loadedSliders++;
};

/* Скрытие прелоадера */
window.hidePreloader = function() {
  const loader = document.getElementById('loadingOverlay');
  if (loader && loader.style.display !== 'none') {
    loader.style.opacity = '0';
    setTimeout(() => {
      loader.style.display = 'none';
      
      // Запускаем остальные функции после загрузки
      setupScrollReveal();
      createHeartsSystem();
      setupMusicPlayer();
      setupHeroScrollAnimation();
      
      setTimeout(() => {
        document.querySelectorAll('.memory-section, .fade-in').forEach(el => {
          const rect = el.getBoundingClientRect();
          if (rect.top < window.innerHeight * 0.9) {
            el.classList.add('visible');
          }
        });
      }, 100);
    }, 500);
  }
};

/* Предзагрузка изображения героя */
function preloadHeroImage() {
  const heroBg = document.getElementById('heroBg');
  const heroImageUrl = "обложка.jpg";
  
  const img = new Image();
  img.onload = function() {
    window.globalLoadingState.heroImageLoaded = true;
    window.updateGlobalLoadingProgress();
    
    // Устанавливаем фон только после загрузки
    heroBg.style.backgroundImage = `url("${heroImageUrl}")`;
  };
  
  img.onerror = function() {
    window.globalLoadingState.heroImageLoaded = true;
    window.updateGlobalLoadingProgress();
    
    // Показываем сообщение об ошибке
    heroBg.style.backgroundColor = '#1a1a1a';
    heroBg.style.display = 'flex';
    heroBg.style.alignItems = 'center';
    heroBg.style.justifyContent = 'center';
    heroBg.innerHTML = '<div style="color:#ffe4f0; text-align:center; padding:20px;">Обложка не загружена</div>';
  };
  
  img.src = heroImageUrl;
}

/* Инициализация */
window.addEventListener("load", () => {
  window.scrollTo(0, 0);
  
  // Предотвращаем масштабирование на мобильных
  document.addEventListener('touchmove', function(e) {
    if(e.scale !== 1) {
      e.preventDefault();
    }
  }, { passive: false });
  
  // Предотвращаем двойной тап для зумирования
  let lastTouchEnd = 0;
  document.addEventListener('touchend', function(e) {
    const now = Date.now();
    if (now - lastTouchEnd <= 300) {
      e.preventDefault();
    }
    lastTouchEnd = now;
  }, { passive: false });
  
  // Начинаем предзагрузку обложки
  preloadHeroImage();
  
  // Рендерим секции
  renderSections();
});

// Очистка интервала сердечек
window.addEventListener('beforeunload', () => {
  if (window.heartInterval) {
    clearInterval(window.heartInterval);
  }
});

// Фоллбек на случай если прелоадер не скрылся (таймаут 40 секунд)
setTimeout(() => {
  const loader = document.getElementById('loadingOverlay');
  if (loader && loader.style.display !== 'none') {
    loader.style.opacity = '0';
    setTimeout(() => {
      loader.style.display = 'none';
      setupScrollReveal();
      createHeartsSystem();
      setupMusicPlayer();
      setupHeroScrollAnimation();
    }, 500);
  }
}, 40000);